

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="sanyinjiang">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、环境信息介绍     主机名 IP root密码 规格 磁盘 操作系统 备注     ksp-deploy 172.25.253.106 cloud@123 4c8g 400g Ubuntu 20.04.3 LTS-aarch64 联网，生成artifact等文件   node01 172.25.253.93 cloud@123 8c16">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s离线部署-使用kubekey部署aarch64高可用版k8s1.23.17+ksp3.4.1">
<meta property="og:url" content="https://jiangsanyin.github.io/2024/12/06/k8s%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2-%E4%BD%BF%E7%94%A8kubekey%E9%83%A8%E7%BD%B2arm64%E9%AB%98%E5%8F%AF%E7%94%A8%E7%89%88k8s1-23-17-ksp3-4-1/index.html">
<meta property="og:site_name" content="sanyinjiang">
<meta property="og:description" content="一、环境信息介绍     主机名 IP root密码 规格 磁盘 操作系统 备注     ksp-deploy 172.25.253.106 cloud@123 4c8g 400g Ubuntu 20.04.3 LTS-aarch64 联网，生成artifact等文件   node01 172.25.253.93 cloud@123 8c16">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/12/28/qSkxtXjcFlwdTOs.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/30/figQNSrTJ5RIWeZ.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/29/VKPmkQFJB6pUXbs.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/29/PtgGJ71CjWSfEZY.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/30/cpIRmhfQl69xLZ3.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/30/3LfSJPVpq6zwTAe.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/31/TkcI3ZlBXCdhmvA.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/31/RKht1DJzk2FAogm.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/30/FuNh3jOedGBbZwC.png">
<meta property="og:image" content="https://s2.loli.net/2024/12/30/OsUv98dunWCNKJy.png">
<meta property="article:published_time" content="2024-12-06T13:18:42.000Z">
<meta property="article:modified_time" content="2025-03-16T15:02:04.000Z">
<meta property="article:author" content="sanyinjiang">
<meta property="article:tag" content="kubekey 离线部署 arm64 k8s kubesphere">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2024/12/28/qSkxtXjcFlwdTOs.png">
  
  
  
  <title>k8s离线部署-使用kubekey部署aarch64高可用版k8s1.23.17+ksp3.4.1 - sanyinjiang</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"jiangsanyin.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"lhgjNNoNy5Syl0F4Bw8i5P5K-gzGzoHsz","app_key":"0d6M8Wx7ZmYewOQqA20Nbqen","server_url":"https://lhgjnnon.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sanyinjiang</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">k8s离线部署-使用kubekey部署aarch64高可用版k8s1.23.17+ksp3.4.1</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-06 21:18" pubdate>
          2024年12月6日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          49 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">k8s离线部署-使用kubekey部署aarch64高可用版k8s1.23.17+ksp3.4.1</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="一环境信息介绍">一、环境信息介绍</h1>
<table>

<thead>
<tr>
<th><strong>主机名</strong></th>
<th><strong>IP</strong></th>
<th><strong>root密码</strong></th>
<th><strong>规格</strong></th>
<th><strong>磁盘</strong></th>
<th><strong>操作系统</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ksp-deploy</td>
<td>172.25.253.106</td>
<td>cloud@123</td>
<td>4c8g</td>
<td>400g</td>
<td>Ubuntu 20.04.3 LTS-aarch64</td>
<td>联网，生成artifact等文件</td>
</tr>
<tr>
<td>node01</td>
<td>172.25.253.93</td>
<td>cloud@123</td>
<td>8c16g</td>
<td>400g</td>
<td>Ubuntu 20.04.3 LTS-aarch64</td>
<td>控制节点</td>
</tr>
<tr>
<td>node02</td>
<td>172.25.253.94</td>
<td>cloud@123</td>
<td>8c16g</td>
<td>400g</td>
<td>Ubuntu 20.04.3 LTS-aarch64</td>
<td>控制节点</td>
</tr>
<tr>
<td>node03</td>
<td>172.25.253.95</td>
<td>cloud@123</td>
<td>8c16g</td>
<td>400g</td>
<td>Ubuntu 20.04.3 LTS-aarch64</td>
<td>控制节点</td>
</tr>
<tr>
<td>node04</td>
<td>172.25.253.113</td>
<td>cloud@123</td>
<td>8c16g</td>
<td>400g</td>
<td>Ubuntu 20.04.3 LTS-aarch64</td>
<td>工作节点</td>
</tr>
<tr>
<td>node05</td>
<td>172.25.253.114</td>
<td>cloud@123</td>
<td>8c16g</td>
<td>400g</td>
<td>Ubuntu 20.04.3 LTS-aarch64</td>
<td>工作节点</td>
</tr>
</tbody>
</table>
<p>环境涉及软件版本信息：</p>
<ul>
<li>K8S节点操作系统：<strong>Ubuntu 20.04.3 LTS -aarch64</strong></li>
<li>KubeSphere：<strong>v3.4.1</strong></li>
<li>K8S：<strong>v1.23.17</strong></li>
<li>Docker：<strong>24.0.6</strong></li>
<li>KubeKey: <strong>v3.0.13</strong></li>
<li>cni-plugins: <strong>v1.2.0</strong></li>
<li>crictl: <strong>v1.24.0</strong></li>
<li>etcd: <strong>v3.4.13</strong></li>
<li>helm: <strong>v3.9.0</strong></li>
<li>kubeadm、kubectl、kubelet: <strong>v1.23.17</strong></li>
</ul>
<p>​ <a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey">KubeKey</a> 使用
<code>/var/lib/docker</code> 作为默认路径来存储所有 Docker
相关文件（包括镜像）。建议添加附加存储卷（本文中未添加），分别给
<code>/var/lib/docker</code> 和 <code>/mnt/registry</code> 挂载至少
<strong>100G</strong>。</p>
<p>​
本文假设联网的服务器ksp-deploy上相关基础操作如安装、配置docker等已经完成，未进行介绍说明。</p>
<h1 id="二离线安装介绍">二、离线安装介绍</h1>
<p>​ KubeKey 从 v2.1.0 版开始新增了清单 (manifest) 和制品 (artifact)
的概念，为用户离线部署 KubeSphere 和 K8s
集群提供了一种简单便捷的解决方案。</p>
<p>​ manifest 是一个描述当前 Kubernetes 集群信息和定义 artifact
制品中需要包含哪些内容的文本文件。</p>
<p>​ 使用 KubeKey，用户只需使用清单 manifest
文件来定义将要离线部署的集群环境需要的内容，再通过该 manifest 来导出制品
artifact 文件即可完成准备工作。离线部署时只需要 KubeKey 和 artifact
就可快速、简单的在环境中部署镜像仓库 Harbor 和 KubeSphere 以及 K8s
集群。</p>
<p>​ KubeKey 生成 manifest 文件有两种方式：</p>
<ul>
<li>利用现有运行中的集群作为源生成 manifest
文件，是官方推荐的一种方式，具体参考 KubeSphere <a
target="_blank" rel="noopener" href="https://v3-1.docs.kubesphere.io/zh/docs/installing-on-linux/introduction/air-gapped-installation/">官网的离线部署文档</a>。</li>
<li>根据 <a
target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/blob/master/docs/manifest-example.md">manifest
模板文件</a> 手动编写 manifest 文件。</li>
</ul>
<p>​ 第一种方式的好处是可以根据 1:1
的运行集群构建离线集群，依赖于已有集群，灵活度不够，并不是所有人都具备这种条件。</p>
<p>​
但本文中涉及的是arm64构架服务器上搭建k8s1.23.17+ksp3.4.1环境，上述方法在amd64构架服务器上能成功，在此处不能成功（至少笔者自己未成功。其中笔者遇到失败之处就是不论是否使用harbor做镜像仓库，安装过程中都会尝试去下载harbor安装文件，但harbor官方并未提供arm64的安装文件，所以反复下载、反复失败）。所以笔者选择了逐步手动下载相关安装二进制文件、镜像与其他工具文件等，最后完成arm64构架服务器上k8s1.23.17+ksp3.4.1环境的安装部署。其中最关键的在于提前下载准备好离线安装k8s1.23.17+ksp3.4.1环境中用到<strong>Kubernetes二进制文件、Kubernetes与Kubesphere用到的镜像</strong>，其他的大致都是围绕此二者展开进行准备。</p>
<h1 id="三服务器的前置操作">三、服务器的前置操作</h1>
<p>建议所有服务器都要执行。</p>
<h2 id="设置各服务器时区">3.1 设置各服务器时区</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">timedatectl set-timezone Asia/Shanghai<br></code></pre></td></tr></table></figure>
<h2 id="设置各服务器主机名">3.2 设置各服务器主机名</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">hostnamectl set-hostname xxx<br><span class="hljs-meta prompt_">#</span><span class="language-bash">然后退出终端并重新创建一个终端会话</span><br></code></pre></td></tr></table></figure>
<h2 id="设置主机与ip的映射信息">3.3 设置主机与ip的映射信息</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt;&gt; /etc/hosts &lt;&lt;EOF<br>172.25.253.106 ksp-deploy<br>172.25.253.93 node01<br>172.25.253.94 node02<br>172.25.253.95 node03<br>172.25.253.113 node04<br>172.25.253.114 node05<br>EOF<br></code></pre></td></tr></table></figure>
<h2 id="设置时间同步">3.4 设置时间同步</h2>
<p>​
最好以离线k8s环境的某个节点做时间同步的源服务器。本文为了简化操作，未执行。生产环境中建议执行。</p>
<h1 id="四离线部署资源制作">四、离线部署资源制作</h1>
<p>制作离线部署资源需要找一台能联通互联网的节点（本文中是ksp-deploy），本文为了资源的制作和离线部署验证，单独增加了一个能联网的
<strong>ksp-deploy</strong> 节点。</p>
<p>在该节点下载 KubeKey （下文简称 KK）<strong>v3.0.13</strong>。具体 KK
版本号可以在 <a
target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/releases">KubeKey
发行页面</a> 查看。</p>
<h2 id="下载-kubekey">4.1 下载 KubeKey</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ksp-deploy:~# mkdir /root/kubekey<br>root@ksp-deploy:~# cd /root/kubekey<br><span class="hljs-meta prompt_"># </span><span class="language-bash">选择中文区下载(访问 GitHub 受限时使用)</span><br>root@ksp-deploy:~/kubekey# export KKZONE=cn<br><span class="hljs-meta prompt_"># </span><span class="language-bash">执行下载命令，获取指定版本的 kk（受限于网络可能会失败，可能需要执行多次）</span><br>root@ksp-deploy:~/kubekey# curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.13 sh -<br></code></pre></td></tr></table></figure>
<figure>
<img src="https://s2.loli.net/2024/12/28/qSkxtXjcFlwdTOs.png" srcset="/img/loading.gif" lazyload
alt="image-20241228172413417" />
<figcaption aria-hidden="true">image-20241228172413417</figcaption>
</figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ksp-deploy:~/kubekey# chown root:root kk<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看kubekey3.0.13版本</span><br>root@ksp-deploy:~/kubekey# ./kk version<br>kk version: &amp;version.Info&#123;Major:&quot;3&quot;, Minor:&quot;0&quot;, GitVersion:&quot;v3.0.13-dirty&quot;, GitCommit:&quot;ac75d3ef3c22e6a9d999dcea201234d6651b3e72&quot;, GitTreeState:&quot;dirty&quot;, BuildDate:&quot;2023-11-07T08:43:42Z&quot;, GoVersion:&quot;go1.19.2&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/arm64&quot;&#125;<br></code></pre></td></tr></table></figure>
<h2 id="准备安装镜像">4.2 准备安装镜像</h2>
<p>​ 在 Linux 上安装 KubeSphere 和 Kubernetes
时，需要准备所有必需镜像文件，并事先下载 Kubernetes 二进制文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行下面的命令获取官方 releases v3.4.1 对应的 images-list</span><br>root@ksp-deploy:~/kubekey# wget https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/images-list.txt<br></code></pre></td></tr></table></figure>
<p>​
但上述文件不能直接使用（从官网上下载下来的这个文件应该只是x86平台上验证过的。这个文件中有些镜像并没有对应arm64版本镜像；此外，非全量安装时不是所有镜像都是需要的）。
​经过修改后image-list.txt文件如下（已经经过验证）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ksp-deploy:~/kubekey#  cat images-list.txt<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#k8s-images</span></span><br>kubesphere/pause:3.6<br>kubesphere/kube-apiserver:v1.23.17<br>kubesphere/kube-controller-manager:v1.23.17<br>kubesphere/kube-scheduler:v1.23.17<br>kubesphere/kube-proxy:v1.23.17<br>coredns/coredns:1.8.6<br>kubesphere/k8s-dns-node-cache:1.15.12<br>calico/kube-controllers:v3.26.1<br>calico/cni:v3.26.1<br>calico/node:v3.26.1<br>calico/pod2daemon-flexvol:v3.26.1<br>openebs/provisioner-localpv:3.3.0<br>openebs/linux-utils:3.3.0<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#kubesphere-images</span></span><br>kubesphere/ks-installer:v3.4.1<br>kubesphere/ks-apiserver:v3.4.1<br>kubesphere/ks-console:v3.4.1<br>kubesphere/ks-controller-manager:v3.4.1<br>kubesphere/kubectl:v1.20.0<br>kubesphere/kubectl:v1.22.0<br>kubesphere/kubefed:v0.8.1<br>kubesphere/tower:v0.2.1<br>minio/minio:RELEASE.2024-08-17T01-24-54Z<br>minio/mc:RELEASE.2024-08-17T11-33-50Z<br>csiplugin/snapshot-controller:v4.0.0<br>kubesphere/nginx-ingress-controller:v1.3.1<br>mirrorgooglecontainers/defaultbackend-arm64:1.4<br>kubesphere/metrics-server:v0.4.2<br>redis:5.0.14-alpine<br>haproxy:2.0.25-alpine<br>haproxy:2.3<br>alpine:3.14<br>osixia/openldap:1.3.0<br>kubesphere/netshoot:v1.0<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#kubeedge-images</span></span><br>kubeedge/cloudcore:v1.13.0<br>kubesphere/iptables-manager:v1.13.0<br>kubesphere/edgeservice:v0.3.0<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#gatekeeper-images</span></span><br>openpolicyagent/gatekeeper:v3.5.2<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#openpitrix-images</span></span><br>kubesphere/openpitrix-jobs:v3.3.2<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#kubesphere-devops-images</span></span><br>kubesphere/devops-apiserver:ks-v3.4.1<br>kubesphere/devops-controller:ks-v3.4.1<br>kubesphere/devops-tools:ks-v3.4.1<br>kubesphere/ks-jenkins:v3.4.0-2.319.3-1<br>jenkins/inbound-agent:4.10-2<br>kubesphere/s2ioperator:v3.2.1<br>kubesphere/java-11-centos7:v3.2.0<br>kubesphere/java-8-centos7:v3.2.0<br>quay.io/argoproj/argocd:v2.3.3<br>quay.io/argoproj/argocd-applicationset:v0.4.1<br>ghcr.io/dexidp/dex:v2.30.2<br>redis:6.2.6-alpine<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#kubesphere-monitoring-images</span></span><br>jimmidyson/configmap-reload:v0.7.1<br>prom/prometheus:v2.39.1<br>kubesphere/prometheus-config-reloader:v0.55.1<br>kubesphere/prometheus-operator:v0.55.1<br>kubesphere/kube-rbac-proxy:v0.11.0<br>kubesphere/kube-state-metrics:v2.6.0<br>prom/node-exporter:v1.3.1<br>prom/alertmanager:v0.23.0<br>thanosio/thanos:v0.31.0<br>grafana/grafana:8.3.3<br>kubesphere/kube-rbac-proxy:v0.11.0<br>kubesphere/notification-manager-operator:v2.3.0<br>kubesphere/notification-manager:v2.3.0<br>kubesphere/notification-tenant-sidecar:v3.2.0<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#kubesphere-logging-images</span></span><br>kubesphere/opensearch-curator:v0.0.5<br>kubesphere/fluent-bit:v1.9.4<br>kubesphere/log-sidecar-injector:v1.2.0<br>elastic/filebeat:6.7.0<br>kubesphere/kube-events-operator:v0.6.0<br>kubesphere/kube-events-ruler:v0.6.0<br>kubesphere/kube-auditing-operator:v0.2.0<br>kubesphere/kube-auditing-webhook:v0.2.0<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#istio-images</span></span><br>jaegertracing/jaeger-operator:1.29<br>jaegertracing/jaeger-agent:1.29<br>jaegertracing/jaeger-collector:1.29<br>jaegertracing/jaeger-query:1.29<br>jaegertracing/jaeger-es-index-cleaner:1.29<br>kubesphere/kiali-operator:v1.50.1<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#example-images</span></span><br>busybox:1.31.1<br></code></pre></td></tr></table></figure>
<h2 id="下载-kubernetes-二进制文件">4.3 下载 Kubernetes 二进制文件</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">下载 offline-installation-tool.sh</span><br>root@ksp-deploy:~/kubekey# curl -L -O https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/offline-installation-tool.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">给文件增加可执行权限</span><br>root@ksp-deploy:~/kubekey# chmod +x offline-installation-tool.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">执查看如何使用脚本</span><br>root@ksp-deploy:~/kubekey# ./offline-installation-tool.sh -h<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载 Kubernetes 二进制文件</span><br>root@ksp-deploy:~/kubekey# export KKZONE=cn<br>root@ksp-deploy:~/kubekey# export HELM_VERSION=v3.9.0 &amp;&amp; export CNI_VERSION=v1.2.0 &amp;&amp; export CRICTL_VERSION=v1.24.0 &amp;&amp; export ETCD_VERSION=v3.4.13 &amp;&amp; export DOCKER_VERSION=24.0.6;<br>root@ksp-deploy:~/kubekey# ./offline-installation-tool.sh -b -v v1.23.17<br><span class="hljs-meta prompt_">#</span><span class="language-bash">运行脚本后，会在当前目录下自动创建一个文件夹 kubekey。请注意，后面创建集群时，该文件夹和 kk 必须放在同一个目录</span><br></code></pre></td></tr></table></figure>
<figure>
<img src="https://s2.loli.net/2024/12/30/figQNSrTJ5RIWeZ.png" srcset="/img/loading.gif" lazyload
alt="image-20241230195525723" />
<figcaption aria-hidden="true">image-20241230195525723</figcaption>
</figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">还需要下载一个calicoctl-linux-arm64 文件</span><br>root@ksp-deploy:~/kubekey# curl -L -o kubekey/v1.23.17/arm64/calicoctl-linux-arm64 https://github.com/projectcalico/calico/releases/download/v3.26.1/calicoctl-linux-arm64 -O <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看创建的文件夹及下载的文件</span><br>root@ksp-deploy:~/kubekey# ls -alh kubekey/v1.23.17/arm64/<br>total 419M<br>drwxr-xr-x 2 root root 4.0K Dec 30 20:12 .<br>drwxr-xr-x 3 root root 4.0K Dec 29 17:05 ..<br>-rw-r--r-- 1 root root  59M Dec 30 19:30 calicoctl-linux-arm64<br>-rw-r--r-- 1 root root  37M Dec 30 19:53 cni-plugins-linux-arm64-v1.2.0.tgz<br>-rw-r--r-- 1 root root  13M Dec 30 19:53 crictl-v1.24.0-linux-arm64.tar.gz<br>-rw-r--r-- 1 root root  61M Oct 26  2023 docker-24.0.6.tgz<br>-rw-r--r-- 1 root root  16M Dec 30 19:53 etcd-v3.4.13-linux-arm64.tar.gz<br>-rw-r--r-- 1 root root  44M Dec 30 19:52 helm<br>-rw-r--r-- 1 root root  41M Dec 30 19:51 kubeadm<br>-rw-r--r-- 1 root root  42M Dec 30 19:52 kubectl<br>-rw-r--r-- 1 root root 110M Dec 30 19:52 kubelet<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">笔者在下载时docker虽然显示成功但其实下载下来的 kubekey/v1.23.17/arm64/docker-24.0.6.tgz 文件只有2.3K，并不可用</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">于是手动重新下载</span><br>root@ksp-deploy:~/kubekey# wget https://download.docker.com/linux/static/stable/aarch64/docker-24.0.6.tgz -O kubekey/v1.23.17/arm64/docker-24.0.6.tgz<br>root@ksp-deploy:~/kubekey# ls -alh kubekey/v1.23.17/arm64/docker-24.0.6.tgz<br>-rw-r--r-- 1 root root 61M Oct 26  2023 kubekey/v1.23.17/arm64/docker-24.0.6.tgz<br></code></pre></td></tr></table></figure>
<h2 id="拉取部署过程中的镜像">4.4 拉取部署过程中的镜像</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ksp-deploy:~/kubekey# ./offline-installation-tool.sh -s -l images-list.txt -d ./kubesphere-images<br><span class="hljs-meta prompt_">#</span><span class="language-bash">总共大概有4G左右</span><br></code></pre></td></tr></table></figure>
<figure>
<img src="https://s2.loli.net/2024/12/29/VKPmkQFJB6pUXbs.png" srcset="/img/loading.gif" lazyload
alt="image-20241229171432036" />
<figcaption aria-hidden="true">image-20241229171432036</figcaption>
</figure>
<h2 id="准备registry2镜像">4.5 准备registry:2镜像</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ksp-deploy:~/kubekey# docker pull registry:2<br>root@ksp-deploy:~/kubekey# docker save -o registry-2.tar.gz registry:2<br></code></pre></td></tr></table></figure>
<h2 id="打包压缩部署镜像文件">4.6 打包压缩部署镜像文件</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">将 整个kubesphere-images/ 目录打包压缩成一个文件</span><br>root@ksp-deploy:~/kubekey# tar -zcf kubesphere-images.tar.gz kubesphere-images/<br>root@ksp-deploy:~/kubekey# ls -alh kubesphere-images.tar.gz<br>-rw-r--r-- 1 root root 4.0G Dec 29 17:26 kubesphere-images.tar.gz<br></code></pre></td></tr></table></figure>
<h2 id="准备与打包压缩依赖组件离线安装包">4.7
准备与打包压缩依赖组件离线安装包</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">方法1：如下方法只下载部署k8s与kubesphere时需要用到的依赖组件 的离线安装文件</span><br>root@ksp-deploy:~/kubekey# mkdir dependent-components<br>root@ksp-deploy:~/kubekey# cd dependent-components<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看依赖：</span><br>root@ksp-deploy:~/kubekey/dependent-components# apt-cache depends socat conntrack ebtables ipset ipvsadm<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载 deb 依赖包</span><br>root@ksp-deploy:~/kubekey/dependent-components# apt-get download $(apt-cache depends --recurse --no-recommends --no-suggests --no-conflicts --no-breaks --no-replaces --no-enhances --no-pre-depends depends socat conntrack ebtables ipset ipvsadm | grep -v i386 | grep &quot;^\w&quot;)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">打包压缩</span><br>root@ksp-deploy:~/kubekey# tar -zcf dependent-components.tar.gz dependent-components/<br>root@ksp-deploy:~/kubekey# ls -alh dependent-components.tar.gz <br>-rw-r--r-- 1 root root 6.8M Dec 30 13:03 dependent-components.tar.gz<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法2：真正在离线部署此类环境应该会准备一个操作系统的常用组件离线安装本地源，此处不展开阐述</span><br></code></pre></td></tr></table></figure>
<h2 id="打包压缩其他文件">4.8 打包压缩其他文件</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">把 KubeKey文件夹、kubekey-v3.0.13-linux-arm64.tar.gz、offline-installation-tool.sh等5个文件（夹）也制作成压缩包，便于拷贝到离线节点。</span><br>root@ksp-deploy:~/kubekey# tar -zcf deploy-files.tar.gz kubekey kubekey-v3.0.13-linux-arm64.tar.gz offline-installation-tool.sh registry-2.tar.gz images-list.txt<br>root@ksp-deploy:~/kubekey# ls -alh deploy-files.tar.gz <br>-rw-r--r-- 1 root root 250M Dec 30 20:15 deploy-files.tar.gz<br></code></pre></td></tr></table></figure>
<p>至此，我们已经准备了如下离线部署资源包：</p>
<ul>
<li>部署镜像文件：<strong>kubesphere-images.tar.gz（4.0G）</strong></li>
<li>部署工具文件：<strong>deploy-files.tar.gz（250M）</strong></li>
<li>依赖组件离线安装包：<strong>dependent-components.tar.gz（6.8M）</strong></li>
</ul>
<h1 id="五部署-ksp-和-k8s-的前置准备操作">五、部署 KSP 和 K8S
的前置准备操作</h1>
<h2 id="上传离线部署资源包到部署节点">5.1
上传离线部署资源包到部署节点</h2>
<p>将以下离线部署资源包（kubesphere-images.tar.gz、dependent-components.tar.gz与deploy-files.tar.gz
），上传至离线环境部署节点 (此处是 <strong>node01</strong>
节点，所有节点信息参考文档最开始处的描述) 的 /opt/deploy-k8s-ksp
目录（可根据实际情况修改）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创离线资源存放的数据目录</span><br>root@node01:/# mkdir /opt/deploy-k8s-ksp<br><span class="hljs-meta prompt_"># </span><span class="language-bash">上传kubesphere-images.tar.gz与deploy-files.tar.gz 文件到node01:/opt/deploy-k8s-ksp 目录下</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">执行以下命令，解压相关文件：</span><br>root@node01:/opt/deploy-k8s-ksp# tar -zxf kubesphere-images.tar.gz<br>root@node01:/opt/deploy-k8s-ksp# tar -zxf deploy-files.tar.gz<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">至此获得如下文件（夹）</span><br>root@node01:/opt/deploy-k8s-ksp# ls -alh<br>total 4.3G<br>drwxr-xr-x  7 root root 4.0K Dec 30 20:17 .<br>drwxr-xr-x  5 root root 4.0K Dec 30 19:32 ..<br>-rw-r--r--  1 root root 6.8M Dec 30 13:04 dependent-components.tar.gz<br>-rw-r--r--  1 root root 250M Dec 30 20:17 deploy-files.tar.gz<br>-rw-r--r--  1 root root 2.7K Dec 30 19:34 images-list.txt<br>drwxr-xr-x 16 root root 4.0K Dec 29 17:05 kubekey<br>-rw-r--r--  1 root root  32M Dec 28 17:23 kubekey-v3.0.13-linux-arm64.tar.gz<br>drwxr-xr-x  2 root root 4.0K Dec 29 17:10 kubesphere-images<br>-rw-r--r--  1 root root 4.0G Dec 29 17:35 kubesphere-images.tar.gz<br>-rwxr-xr-x  1 root root 8.6K Dec  6 22:52 offline-installation-tool.sh<br>-rw-------  1 root root  25M Dec 29 17:29 registry-2.tar.gz<br></code></pre></td></tr></table></figure>
<h2 id="安装docker容器服务">5.2 安装docker容器服务</h2>
<p>​ k8s集群的每个节点都要安装与配置。将node01节点上的
/opt/deploy-k8s-ksp/kubekey/v1.23.17/arm64/docker-24.0.6.tgz
复制到k8s集群的其他所有节点上，然后按照如下方式解压与部署docker服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">按照如下方式解压与部署docker服务</span><br>root@node01:/opt/deploy-k8s-ksp# tar -zxf kubekey/v1.23.17/arm64/docker-24.0.6.tgz<br>root@node01:/opt/deploy-k8s-ksp# chown root:root -R docker/<br>root@node01:/opt/deploy-k8s-ksp# mv docker/* /usr/bin/ &amp;&amp; rmdir docker<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">使用systemd管理docker服务</span><br>root@node01:/opt/deploy-k8s-ksp# cat &gt; /etc/systemd/system/docker.service &lt;&lt;EOF<br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>ExecStart=/usr/bin/dockerd<br>ExecReload=/bin/kill -s HUP $MAINPID<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>TimeoutStartSec=0<br>Delegate=yes<br>KillMode=process<br>Restart=on-failure<br>StartLimitBurst=3<br>StartLimitInterval=60s<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置docker守护进程配置文件：/etc/docker/daemon.json</span><br>root@node01:/opt/deploy-k8s-ksp# mkdir -p /etc/docker<br>root@node01:/opt/deploy-k8s-ksp# cat &gt; /etc/docker/daemon.json &lt;&lt;EOF<br>&#123;<br>    &quot;insecure-registries&quot;: [<br>        &quot;dockerhub.kubekey.local&quot;<br>    ],<br>    &quot;log-opts&quot;: &#123;<br>        &quot;max-file&quot;: &quot;5&quot;,<br>        &quot;max-size&quot;: &quot;50m&quot;<br>    &#125;,<br>    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在 /etc/hosts 中添加一个条目，将主机名（即仓库域名；在本示例中是 dockerhub.kubekey.local）映射到docker resgistry所在服务器的私有 IP 地址，如下所示，以下规划172.25.253.93是docker resgistry所在服务器</span><br>root@node01:/opt/deploy-k8s-ksp# cat &gt;&gt; /etc/hosts &lt;&lt;EOF<br>172.25.253.93 dockerhub.kubekey.local<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">应用上述文件并启动dicker服务，设置开机自启动</span><br>root@node01:/opt/deploy-k8s-ksp# systemctl daemon-reload &amp;&amp; systemctl restart docker<br>root@node01:/opt/deploy-k8s-ksp# systemctl status docker<br>root@node01:/opt/deploy-k8s-ksp# systemctl enable docker.service<br><br>root@node01:/opt/deploy-k8s-ksp# docker version          <br>Client:<br> Version:           24.0.6<br> API version:       1.43<br> Go version:        go1.20.7<br> Git commit:        ed223bc<br> Built:             Mon Sep  4 12:30:04 2023<br> OS/Arch:           linux/arm64<br> Context:           default<br><br>Server: Docker Engine - Community<br> Engine:<br>  Version:          24.0.6<br>  API version:      1.43 (minimum version 1.12)<br>  Go version:       go1.20.7<br>  Git commit:       1a79695<br>  Built:            Mon Sep  4 12:31:30 2023<br>  OS/Arch:          linux/arm64<br>  Experimental:     false<br> containerd:<br>  Version:          v1.7.3<br>  GitCommit:        7880925980b188f4c97b462f709d0db8e8962aff<br> runc:<br>  Version:          1.1.9<br>  GitCommit:        v1.1.9-0-gccaecfc<br> docker-init:<br>  Version:          0.19.0<br>  GitCommit:        de40ad0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动docker命令自动补全</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">root@node01:/opt/deploy-k8s-ksp# <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;source &lt;(docker completion bash)&quot;</span> &gt;&gt; /root/.bashrc</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">root@node01:/opt/deploy-k8s-ksp# <span class="hljs-built_in">source</span> /root/.bashrc</span><br></code></pre></td></tr></table></figure>
<h2 id="安装依赖组件">5.3 安装依赖组件</h2>
<p>​
k8s集群的每个节点都要安装与配置。将node01节点上的/opt/deploy-k8s-ksp/kubekey/dependent-components.tar.gz
复制到k8s集群的其他所有节点上，然后按照如下方式解压与安装依赖组件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@node01:/opt/deploy-k8s-ksp# tar -zxf dependent-components.tar.gz<br>root@node01:/opt/deploy-k8s-ksp# cd dependent-components<br><span class="hljs-meta prompt_">#</span><span class="language-bash">使用dpkg命令进行离线安装</span><br>root@node01:/opt/deploy-k8s-ksp/dependent-components# dpkg -i *.deb<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">可以先做好ssh免密登录</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">传输 dependent-components.tar.gz 到node01之外的其他k8s节点 /opt/deploy-k8s-ksp/ 目录下</span><br>root@node01:/opt/deploy-k8s-ksp# for i in &#123;2..5&#125;; do ssh -t root@node0$&#123;i&#125; &quot;mkdir -p /opt/deploy-k8s-ksp&quot;; done<br>root@node01:/opt/deploy-k8s-ksp# for i in &#123;2..5&#125;; do scp dependent-components.tar.gz root@node0$&#123;i&#125;:/opt/deploy-k8s-ksp/; done <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">k8s集群所有节点安装依赖组件</span><br>root@node01:/opt/deploy-k8s-ksp# for i in &#123;1..5&#125;; do ssh -t root@node0$&#123;i&#125; &quot;cd /opt/deploy-k8s-ksp &amp;&amp; tar -zxf dependent-components.tar.gz &amp;&amp; cd dependent-components &amp;&amp; dpkg -i *.deb&quot;; done<br></code></pre></td></tr></table></figure>
<h2 id="准备一个私有镜像仓库">5.4 准备一个私有镜像仓库</h2>
<p>​
Harbor官方未提供harbor安装文件，虽然笔者已经找到在arm64服务器上部署harbor的方法，但本文以
Docker 仓库作为镜像仓库存储k8s部署过程中需要用到的镜像，并使用<a
target="_blank" rel="noopener" href="https://docs.docker.com/registry/insecure/#use-self-signed-certificates">自签名证书</a>。</p>
<p>​ 本文在node01上搭建 Docker 仓库。</p>
<h3 id="使用自签名证书">使用自签名证书</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令生成您自己的证书</span><br>root@node01:/opt/deploy-k8s-ksp# mkdir certs<br>root@node01:/opt/deploy-k8s-ksp# openssl req -addext &quot;subjectAltName = DNS:dockerhub.kubekey.local&quot; \<br>  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \<br>  -x509 -days 36500 -out certs/domain.crt<br></code></pre></td></tr></table></figure>
<figure>
<img src="https://s2.loli.net/2024/12/29/PtgGJ71CjWSfEZY.png" srcset="/img/loading.gif" lazyload
alt="image-20241229221911321" />
<figcaption aria-hidden="true">image-20241229221911321</figcaption>
</figure>
<h3 id="启动-docker-仓库">启动 Docker 仓库</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">加载registry:2镜像</span><br>root@node01:/opt/deploy-k8s-ksp# docker load -i registry-2.tar.gz <br>2ee1e756df5d: Loading layer [==================================================&gt;]  7.955MB/7.955MB<br>9ef0c8e13134: Loading layer [==================================================&gt;]  898.6kB/898.6kB<br>a7c03a80ddda: Loading layer [==================================================&gt;]  16.65MB/16.65MB<br>55f11e417f9b: Loading layer [==================================================&gt;]  3.584kB/3.584kB<br>caa2189153ef: Loading layer [==================================================&gt;]  2.048kB/2.048kB<br>Loaded image: registry:2<br>root@node01:/opt/deploy-k8s-ksp# docker images <br>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE<br>registry     2         1c6adc34955d   15 months ago   25MB<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">让Docker信任刚生成的证书</span><br>root@node01:/opt/deploy-k8s-ksp# mkdir -p  /etc/docker/certs.d/dockerhub.kubekey.local<br>root@node01:/opt/deploy-k8s-ksp# cp certs/domain.crt  /etc/docker/certs.d/dockerhub.kubekey.local/ca.crt<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令启动 Docker 仓库</span><br>root@node01:/opt/deploy-k8s-ksp# docker run -d \<br> --restart=always \<br> --name registry \<br> -v &quot;$(pwd)&quot;/certs:/certs \<br> -v /mnt/registry:/var/lib/registry \<br> -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \<br> -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \<br> -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \<br> -p 443:443 \<br> registry:2<br></code></pre></td></tr></table></figure>
<h3 id="验证仓库">验证仓库</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">要验证私有仓库是否有效，可以修改镜像registry:2的namespace，然后使用 docker push 和 docker pull 来测试。</span><br>root@node01:/opt/deploy-k8s-ksp# docker tag registry:2 dockerhub.kubekey.local/registry:2<br>root@node01:/opt/deploy-k8s-ksp# docker push dockerhub.kubekey.local/registry:2<br>root@node01:/opt/deploy-k8s-ksp# docker pull dockerhub.kubekey.local/registry:2<br></code></pre></td></tr></table></figure>
<h2 id="推送镜像至私有仓库">5.5 推送镜像至私有仓库</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">将打包的镜像文件传输至您的本地机器，并运行以下命令把它推送至仓库</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">命令中的域名是 dockerhub.kubekey.local，它是docker registry仓库的别名</span><br>root@node01:/opt/deploy-k8s-ksp# ./offline-installation-tool.sh -l images-list.txt -d ./kubesphere-images -r dockerhub.kubekey.local<br></code></pre></td></tr></table></figure>
<h2 id="创建离线集群配置文件">5.6 创建离线集群配置文件</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令创建离线集群配置文件</span><br>root@node01:/opt/deploy-k8s-ksp# tar -zxf kubekey-v3.0.13-linux-arm64.tar.gz <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果在这一步的命令中不添加标志 --with-kubesphere，则不会部署 KubeSphere，只能使用配置文件中的 addons 字段安装，或者后续使用 ./kk create cluster 命令时再次添加这个标志。</span><br>root@node01:/opt/deploy-k8s-ksp# ./kk create config --with-kubesphere v3.4.1 --with-kubernetes v1.23.17 -f ksp-v341-v12317-offline.yaml<br></code></pre></td></tr></table></figure>
<p>命令执行成功后，在当前目录会生成文件名为 ksp-v341-v12317-offline.yaml
的配置文件。</p>
<h2 id="修改-cluster-配置">5.7 修改 Cluster 配置</h2>
<p>​ 在离线集群配置文件文件中 <strong>kind: Cluster</strong>
小节的作用是部署 Kubernetes 集群。本文示例采用 3 个节点同时作为
control-plane、etcd 节点，两个节点作为 worker 节点。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令修改离线集群配置文件 ksp-v341-v12317-offline.yaml</span><br>root@node01:/data/kubekey# vi ksp-v341-v12317-offline.yaml<br></code></pre></td></tr></table></figure>
<p>修改 <strong>kind: Cluster</strong> 小节中 hosts 和 roleGroups
等信息，修改说明如下。</p>
<ul>
<li>hosts：指定节点的
IP、ssh登录用户、ssh登录密码，并指明服务器构架。</li>
<li>roleGroups：指定 3 个 etcd、control-plane 节点，2 个 worker
节点</li>
</ul>
<p>修改controlPlaneEndpoint组的配置：</p>
<ul>
<li>internalLoadbalancer： 启用内置的 HAProxy 负载均衡器</li>
</ul>
<p>添加storage组的配置：</p>
<ul>
<li>storage.openebs.basePath：<strong>新增配置</strong>，指定 openebs
默认存储路径为 <strong>/data/openebs/local</strong></li>
</ul>
<p>修改registry组的配置：</p>
<ul>
<li>registry：使用 docker
registry，它的地址是"dockerhub.kubekey.local"</li>
</ul>
<p>修改或添加的内容如下（其余保持默认）：</p>
<figure>
<img src="https://s2.loli.net/2024/12/30/cpIRmhfQl69xLZ3.png" srcset="/img/loading.gif" lazyload
alt="image-20241230203614561" />
<figcaption aria-hidden="true">image-20241230203614561</figcaption>
</figure>
<h2 id="最后的配置">5.8 最后的配置</h2>
<p>​ 经过上述步骤，我们成功完成了对离线集群配置文件
ksp-v341-v12317-offline.yaml 的修改。此时，修改后的
ksp-v341-v12317-offline.yaml文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubekey.kubesphere.io/v1alpha2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">sample</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">hosts:</span><br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">node01</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.93</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.93</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@123&quot;</span>, <span class="hljs-attr">arch:</span> <span class="hljs-string">arm64</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">node02</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.94</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.94</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@123&quot;</span>, <span class="hljs-attr">arch:</span> <span class="hljs-string">arm64</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">node03</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.95</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.95</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@123&quot;</span>, <span class="hljs-attr">arch:</span> <span class="hljs-string">arm64</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">node04</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.113</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.113</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@123&quot;</span>, <span class="hljs-attr">arch:</span> <span class="hljs-string">arm64</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">node05</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.114</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">172.25</span><span class="hljs-number">.253</span><span class="hljs-number">.114</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@123&quot;</span>, <span class="hljs-attr">arch:</span> <span class="hljs-string">arm64</span> &#125;<br>  <span class="hljs-attr">roleGroups:</span><br>    <span class="hljs-attr">etcd:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node01</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node02</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node03</span><br>    <span class="hljs-attr">control-plane:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node01</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node02</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node03</span><br>    <span class="hljs-attr">worker:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node04</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">node05</span><br>  <span class="hljs-attr">controlPlaneEndpoint:</span><br>    <span class="hljs-comment">## Internal loadbalancer for apiservers </span><br>    <span class="hljs-attr">internalLoadbalancer:</span> <span class="hljs-string">haproxy</span><br>    <span class="hljs-attr">domain:</span> <span class="hljs-string">lb.kubesphere.local</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6443</span><br>  <span class="hljs-attr">kubernetes:</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.23.17</span><br>    <span class="hljs-attr">clusterName:</span> <span class="hljs-string">cluster.local</span><br>    <span class="hljs-attr">autoRenewCerts:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">containerManager:</span> <span class="hljs-string">docker</span><br>  <span class="hljs-attr">etcd:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">kubekey</span><br>  <span class="hljs-attr">network:</span><br>    <span class="hljs-attr">plugin:</span> <span class="hljs-string">calico</span><br>    <span class="hljs-attr">kubePodsCIDR:</span> <span class="hljs-number">10.233</span><span class="hljs-number">.64</span><span class="hljs-number">.0</span><span class="hljs-string">/18</span><br>    <span class="hljs-attr">kubeServiceCIDR:</span> <span class="hljs-number">10.233</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/18</span><br>    <span class="hljs-comment">## multus support. https://github.com/k8snetworkplumbingwg/multus-cni</span><br>    <span class="hljs-attr">multusCNI:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">storage:</span><br>    <span class="hljs-attr">openebs:</span><br>      <span class="hljs-attr">basePath:</span> <span class="hljs-string">/mnt/openebs/local</span> <span class="hljs-comment"># 默认没有，新增的配置，base path of the local PV provisioner</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">privateRegistry:</span> <span class="hljs-string">&quot;dockerhub.kubekey.local&quot;</span><br>    <span class="hljs-attr">namespaceOverride:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">registryMirrors:</span> []<br>    <span class="hljs-attr">insecureRegistries:</span> []<br>  <span class="hljs-attr">addons:</span> []<br><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">installer.kubesphere.io/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubesphere-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v3.4.1</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">persistence:</span><br>    <span class="hljs-attr">storageClass:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">authentication:</span><br>    <span class="hljs-attr">jwtSecret:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">local_registry:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-comment"># dev_tag: &quot;&quot;</span><br>  <span class="hljs-attr">etcd:</span><br>    <span class="hljs-attr">monitoring:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">endpointIps:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">2379</span><br>    <span class="hljs-attr">tlsEnable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">common:</span><br>    <span class="hljs-attr">core:</span><br>      <span class="hljs-attr">console:</span><br>        <span class="hljs-attr">enableMultiLogin:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">30880</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>    <span class="hljs-comment"># apiserver:</span><br>    <span class="hljs-comment">#  resources: &#123;&#125;</span><br>    <span class="hljs-comment"># controllerManager:</span><br>    <span class="hljs-comment">#  resources: &#123;&#125;</span><br>    <span class="hljs-attr">redis:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">enableHA:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">volumeSize:</span> <span class="hljs-string">2Gi</span><br>    <span class="hljs-attr">openldap:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">volumeSize:</span> <span class="hljs-string">2Gi</span><br>    <span class="hljs-attr">minio:</span><br>      <span class="hljs-attr">volumeSize:</span> <span class="hljs-string">20Gi</span><br>    <span class="hljs-attr">monitoring:</span><br>      <span class="hljs-comment"># type: external</span><br>      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span><br>      <span class="hljs-attr">GPUMonitoring:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">gpu:</span><br>      <span class="hljs-attr">kinds:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">resourceName:</span> <span class="hljs-string">&quot;nvidia.com/gpu&quot;</span><br>        <span class="hljs-attr">resourceType:</span> <span class="hljs-string">&quot;GPU&quot;</span><br>        <span class="hljs-attr">default:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">es:</span><br>      <span class="hljs-comment"># master:</span><br>      <span class="hljs-comment">#   volumeSize: 4Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-comment"># data:</span><br>      <span class="hljs-comment">#   volumeSize: 20Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">logMaxAge:</span> <span class="hljs-number">7</span><br>      <span class="hljs-attr">elkPrefix:</span> <span class="hljs-string">logstash</span><br>      <span class="hljs-attr">basicAuth:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalElasticsearchHost:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalElasticsearchPort:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">opensearch:</span><br>      <span class="hljs-comment"># master:</span><br>      <span class="hljs-comment">#   volumeSize: 4Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-comment"># data:</span><br>      <span class="hljs-comment">#   volumeSize: 20Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">logMaxAge:</span> <span class="hljs-number">7</span><br>      <span class="hljs-attr">opensearchPrefix:</span> <span class="hljs-string">whizard</span><br>      <span class="hljs-attr">basicAuth:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;admin&quot;</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;admin&quot;</span><br>      <span class="hljs-attr">externalOpensearchHost:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalOpensearchPort:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">dashboard:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">alerting:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># thanosruler:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">auditing:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># operator:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># webhook:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">devops:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">jenkinsCpuReq:</span> <span class="hljs-number">0.5</span><br>    <span class="hljs-attr">jenkinsCpuLim:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">jenkinsMemoryReq:</span> <span class="hljs-string">4Gi</span><br>    <span class="hljs-attr">jenkinsMemoryLim:</span> <span class="hljs-string">4Gi</span><br>    <span class="hljs-attr">jenkinsVolumeSize:</span> <span class="hljs-string">16Gi</span><br>  <span class="hljs-attr">events:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># operator:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># exporter:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-attr">ruler:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">logging:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">logsidecar:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>      <span class="hljs-comment"># resources: &#123;&#125;</span><br>  <span class="hljs-attr">metrics_server:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">monitoring:</span><br>    <span class="hljs-attr">storageClass:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">node_exporter:</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9100</span><br>      <span class="hljs-comment"># resources: &#123;&#125;</span><br>    <span class="hljs-comment"># kube_rbac_proxy:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># kube_state_metrics:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># prometheus:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   volumeSize: 20Gi</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   operator:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-comment"># alertmanager:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># notification_manager:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   operator:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   proxy:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-attr">gpu:</span><br>      <span class="hljs-attr">nvidia_dcgm_exporter:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>  <span class="hljs-attr">multicluster:</span><br>    <span class="hljs-attr">clusterRole:</span> <span class="hljs-string">none</span><br>  <span class="hljs-attr">network:</span><br>    <span class="hljs-attr">networkpolicy:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">ippool:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">none</span><br>    <span class="hljs-attr">topology:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">none</span><br>  <span class="hljs-attr">openpitrix:</span><br>    <span class="hljs-attr">store:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">servicemesh:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">istio:</span><br>      <span class="hljs-attr">components:</span><br>        <span class="hljs-attr">ingressGateways:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">istio-ingressgateway</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">cni:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">edgeruntime:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">kubeedge:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">cloudCore:</span><br>        <span class="hljs-attr">cloudHub:</span><br>          <span class="hljs-attr">advertiseAddress:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-attr">service:</span><br>          <span class="hljs-attr">cloudhubNodePort:</span> <span class="hljs-string">&quot;30000&quot;</span><br>          <span class="hljs-attr">cloudhubQuicNodePort:</span> <span class="hljs-string">&quot;30001&quot;</span><br>          <span class="hljs-attr">cloudhubHttpsNodePort:</span> <span class="hljs-string">&quot;30002&quot;</span><br>          <span class="hljs-attr">cloudstreamNodePort:</span> <span class="hljs-string">&quot;30003&quot;</span><br>          <span class="hljs-attr">tunnelNodePort:</span> <span class="hljs-string">&quot;30004&quot;</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>        <span class="hljs-comment"># hostNetWork: false</span><br>      <span class="hljs-attr">iptables-manager:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-string">&quot;external&quot;</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>      <span class="hljs-comment"># edgeService:</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">gatekeeper:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># controller_manager:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># audit:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">terminal:</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">600</span><br><br><br><br></code></pre></td></tr></table></figure>
<h2 id="安装配置-harbor">5.9 安装配置 Harbor</h2>
<p>​
arm64服务器上搭建harbor环境可以参考：https://jiangsanyin.github.io/2024/10/30/arm64%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B%E7%9A%84Harbor-v2-11-1%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/。</p>
<p>​ 后续用法跟x86_64构架服务器上的harbor一样。</p>
<h1 id="六安装-kubesphere-和-k8s-集群">六、安装 KubeSphere 和 K8s
集群</h1>
<h2 id="执行安装kubesphere-和-k8s-集群">6.1 执行安装KubeSphere 和 K8s
集群</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建mkdir-copyfile.sh</span><br>root@node01:/opt/deploy-k8s-ksp# touch mkdir-copyfile.sh<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">其内容如下</span><br>root@node01:/opt/deploy-k8s-ksp# cat mkdir-copyfile.sh<br>cd /opt/deploy-k8s-ksp<br>mkdir kubekey/kube<br>mkdir -p kubekey/kube/v1.23.17/arm64/ kubekey/helm/v3.9.0/arm64/ kubekey/cni/v1.2.0/arm64/ kubekey/crictl/v1.24.0/arm64/ kubekey/etcd/v3.4.13/arm64/ kubekey/docker/24.0.6/arm64/ kubekey/cni/v3.26.1/arm64/<br>cp -rp kubekey/v1.23.17/arm64/kube* kubekey/kube/v1.23.17/arm64/<br>cp -rp kubekey/v1.23.17/arm64/helm kubekey/helm/v3.9.0/arm64/<br>cp -rp kubekey/v1.23.17/arm64/cni-plugins-linux-arm64-v1.2.0.tgz kubekey/cni/v1.2.0/arm64/<br>cp -rp kubekey/v1.23.17/arm64/crictl-v1.24.0-linux-arm64.tar.gz kubekey/crictl/v1.24.0/arm64/<br>cp -rp kubekey/v1.23.17/arm64/etcd-v3.4.13-linux-arm64.tar.gz kubekey/etcd/v3.4.13/arm64/<br>cp -rp kubekey/v1.23.17/arm64/docker-24.0.6.tgz kubekey/docker/24.0.6/arm64/<br>cp -rp kubekey/v1.23.17/arm64/calicoctl-linux-arm64 kubekey/cni/v3.26.1/arm64/calicoctl<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">如果 /mnt/openebs/local 目录非空，请将此目录下的所有文件清空，否则安装将失败、提示如下</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">TASK [common : debug] **********************************************************</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">ok: [localhost] =&gt; &#123;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   <span class="hljs-string">&quot;msg&quot;</span>: [</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;1. check the storage configuration and storage server&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;2. make sure the DNS address in /etc/resolv.conf is available&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;3. execute &#x27;kubectl logs -n kubesphere-system -l job-name=minio-make-bucket-job&#x27; to watch logs&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;4. execute &#x27;helm -n kubesphere-system uninstall ks-minio &amp;&amp; kubectl -n kubesphere-system delete job minio-make-bucket-job&#x27;&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;5. Restart the installer pod in kubesphere-system namespace&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   ]</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">&#125;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令，安装 KubeSphere 和 K8s 集群</span><br>root@node01:/opt/deploy-k8s-ksp# bash mkdir-copyfile.sh<br>root@node01:/opt/deploy-k8s-ksp# ./kk create cluster -f ksp-v341-v12317-offline.yaml --yes<br></code></pre></td></tr></table></figure>
<p><strong>参数说明：</strong></p>
<ul>
<li><strong>ksp-v341-v12317-offline.yaml</strong>：离线环境集群的配置文件</li>
</ul>
<p>上面的命令执行后，首先 KubeKey 会检查部署 K8s
的依赖及其他详细要求。检查合格后，系统将提示确认安装。输入
<strong>yes</strong> 并按 ENTER 继续部署。</p>
<figure>
<img src="https://s2.loli.net/2024/12/30/3LfSJPVpq6zwTAe.png" srcset="/img/loading.gif" lazyload
alt="image-20241230205705028" />
<figcaption aria-hidden="true">image-20241230205705028</figcaption>
</figure>
<h2 id="部署后置处理">6.2 部署后置处理</h2>
<h3
id="poddefault-http-backend-75f5768976-6svwx-一直处于imagepullbackoff-状态">6.2.1
pod/default-http-backend-75f5768976-6svwx 一直处于ImagePullBackOff
状态</h3>
<figure>
<img src="https://s2.loli.net/2024/12/31/TkcI3ZlBXCdhmvA.png" srcset="/img/loading.gif" lazyload
alt="image-20241231095318516" />
<figcaption aria-hidden="true">image-20241231095318516</figcaption>
</figure>
<ul>
<li>分析：</li>
</ul>
<p>因为安装程序尝试拉取与使用的镜像是amd64构架镜像，应该是安装程序（具体地说是kk工具）内部的错误。且在此处私有镜像镜像仓库中尝试拉取的镜像并不存在，所以一直拉取不成功。</p>
<ul>
<li>解决办法：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">修改 命名空间kubesphere-controls-system下的pod/default-http-backend-75f5768976-6svwx</span><br>root@node01:/opt/deploy-k8s-ksp# kubectl -n kubesphere-controls-system edit pod default-http-backend-75f5768976-6svwx<br><span class="hljs-meta prompt_">#</span><span class="language-bash">将spec中使用的镜像修改为“dockerhub.kubekey.local/mirrorgooglecontainers/defaultbackend-arm64:1.4”</span><br></code></pre></td></tr></table></figure>
<figure>
<img src="https://s2.loli.net/2024/12/31/RKht1DJzk2FAogm.png" srcset="/img/loading.gif" lazyload
alt="image-20241231095456573" />
<figcaption aria-hidden="true">image-20241231095456573</figcaption>
</figure>
<h2 id="控制节点配置keepalived">6.3 控制节点配置keepalived</h2>
<p>​
暂略。配置keepalived相关方法可以参考：https://jiangsanyin.github.io/2024/08/10/%E6%90%AD%E5%BB%BA%E4%BA%92%E4%B8%BA%E4%B8%BB%E5%A4%87MySQL5-7%E9%9B%86%E7%BE%A4%E5%B9%B6%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2/#2-3-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AEkeepalived</p>
<h1 id="七部署结果验证">七、部署结果验证</h1>
<p>​ 访问kubesphere3.4.1的web管理界面： http://172.25.253.93:30880/login
。默认用户名：admin，其默认密码：P@88w0rd</p>
<p>登录成功后看到的界面：</p>
<figure>
<img src="https://s2.loli.net/2024/12/30/FuNh3jOedGBbZwC.png" srcset="/img/loading.gif" lazyload
alt="image-20241230205947409" />
<figcaption aria-hidden="true">image-20241230205947409</figcaption>
</figure>
<p>查看节点状态：</p>
<figure>
<img src="https://s2.loli.net/2024/12/30/OsUv98dunWCNKJy.png" srcset="/img/loading.gif" lazyload
alt="image-20241230205929259" />
<figcaption aria-hidden="true">image-20241230205929259</figcaption>
</figure>
<h1 id="八参考文档">八、参考文档</h1>
<ul>
<li>https://v3-1.docs.kubesphere.io/zh/docs/installing-on-linux/introduction/air-gapped-installation/</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/k8s%E4%BA%91%E5%8E%9F%E7%94%9F/" class="category-chain-item">k8s云原生</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/kubekey-%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2-arm64-k8s-kubesphere/" class="print-no-link">#kubekey 离线部署 arm64 k8s kubesphere</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>k8s离线部署-使用kubekey部署aarch64高可用版k8s1.23.17+ksp3.4.1</div>
      <div>https://jiangsanyin.github.io/2024/12/06/k8s离线部署-使用kubekey部署arm64高可用版k8s1-23-17-ksp3-4-1/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>sanyinjiang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/12/07/docker-compose%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2FastGPT%E4%B8%8E%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="docker-compose本地部署FastGPT与简单使用">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">docker-compose本地部署FastGPT与简单使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/01/k8s%E5%9C%A8%E7%BA%BF%E9%83%A8%E7%BD%B2-%E4%BD%BF%E7%94%A8kubeasz%E9%83%A8%E7%BD%B2amd64%E9%AB%98%E5%8F%AF%E7%94%A8k8s1-23-17/" title="k8s在线部署-使用kubeasz部署amd64高可用k8s1-23-17">
                        <span class="hidden-mobile">k8s在线部署-使用kubeasz部署amd64高可用k8s1-23-17</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"lhgjNNoNy5Syl0F4Bw8i5P5K-gzGzoHsz","appKey":"0d6M8Wx7ZmYewOQqA20Nbqen","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
