

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="sanyinjiang">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、环境信息介绍（1）   相关服务器信息：    主机名 IP root密码 规格 磁盘 操作系统 备注    prepare 10.13.15.6 cloud@2020 8c16g 400G Ubuntu 20.04.3 LTS -amd64 联网，生成artifact等   k8s01-1 10.13.15.16 cloud@2020 8c16g 400G+960G Ubuntu 20.04">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s离线部署-使用kubekey部署amd64高可用版k8s1.23.17-ksp3.4.1">
<meta property="og:url" content="https://jiangsanyin.github.io/2024/09/27/k8s%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2-%E4%BD%BF%E7%94%A8kubekey%E9%83%A8%E7%BD%B2amd64%E9%AB%98%E5%8F%AF%E7%94%A8%E7%89%88k8s1-23-17-ksp3-4-1/index.html">
<meta property="og:site_name" content="sanyinjiang">
<meta property="og:description" content="一、环境信息介绍（1）   相关服务器信息：    主机名 IP root密码 规格 磁盘 操作系统 备注    prepare 10.13.15.6 cloud@2020 8c16g 400G Ubuntu 20.04.3 LTS -amd64 联网，生成artifact等   k8s01-1 10.13.15.16 cloud@2020 8c16g 400G+960G Ubuntu 20.04">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/09/27/O2KsM3ZyeQWf5wB.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/12/h9FTtslICbfSEJa.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/12/9DOjugW2Gxcdsvy.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/12/jLsZ9bpvfydHUGq.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/12/ZPpxCvWJHVTFGNo.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/12/FYCbxXzr1iyqW2P.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/13/TWuogpE9vHMLIhD.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/13/N5K6mEL3iOxDCJT.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/13/dJ8rIeTRNDsG5ph.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/13/tbTjiM39XGsBowg.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/13/uAV8QrZEKHyX35t.png">
<meta property="article:published_time" content="2024-09-27T02:49:54.000Z">
<meta property="article:modified_time" content="2025-03-16T15:01:52.000Z">
<meta property="article:author" content="sanyinjiang">
<meta property="article:tag" content="amd64构架 k8s1.23.17 kubesphere3.4.1 离线部署">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2024/09/27/O2KsM3ZyeQWf5wB.png">
  
  
  
  <title>k8s离线部署-使用kubekey部署amd64高可用版k8s1.23.17-ksp3.4.1 - sanyinjiang</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"jiangsanyin.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"lhgjNNoNy5Syl0F4Bw8i5P5K-gzGzoHsz","app_key":"0d6M8Wx7ZmYewOQqA20Nbqen","server_url":"https://lhgjnnon.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sanyinjiang</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">k8s离线部署-使用kubekey部署amd64高可用版k8s1.23.17-ksp3.4.1</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-09-27 10:49" pubdate>
          2024年9月27日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          98 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">k8s离线部署-使用kubekey部署amd64高可用版k8s1.23.17-ksp3.4.1</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="一、环境信息介绍"><a href="#一、环境信息介绍" class="headerlink" title="一、环境信息介绍"></a>一、环境信息介绍</h1><p>（1）   相关服务器信息：</p>
<table>
<thead>
<tr>
<th><strong>主机名</strong></th>
<th><strong>IP</strong></th>
<th><strong>root密码</strong></th>
<th><strong>规格</strong></th>
<th><strong>磁盘</strong></th>
<th><strong>操作系统</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>prepare</td>
<td>10.13.15.6</td>
<td>cloud@2020</td>
<td>8c16g</td>
<td>400G</td>
<td>Ubuntu 20.04.3 LTS -amd64</td>
<td>联网，生成artifact等</td>
</tr>
<tr>
<td>k8s01-1</td>
<td>10.13.15.16</td>
<td>cloud@2020</td>
<td>8c16g</td>
<td>400G+960G</td>
<td>Ubuntu 20.04.3 LTS -amd64</td>
<td>K8s节点，未联网</td>
</tr>
<tr>
<td>k8s01-2</td>
<td>10.13.15.17</td>
<td>cloud@2020</td>
<td>8c16g</td>
<td>400G+960G</td>
<td>Ubuntu 20.04.3 LTS -amd64</td>
<td>K8s节点，未联网</td>
</tr>
<tr>
<td>k8s01-3</td>
<td>10.13.15.161</td>
<td>cloud@2020</td>
<td>8c16g</td>
<td>400G+960G</td>
<td>Ubuntu 20.04.3 LTS -amd64</td>
<td>K8s节点，未联网</td>
</tr>
<tr>
<td>k8s01-4</td>
<td>10.13.15.99</td>
<td>cloud@2020</td>
<td>8c16g</td>
<td>400G+960G</td>
<td>Ubuntu 20.04.3 LTS -amd64</td>
<td>K8s节点，未联网</td>
</tr>
<tr>
<td>registry</td>
<td>10.13.15.71</td>
<td>cloud@2020</td>
<td>4c8g</td>
<td>400G</td>
<td>Ubuntu 20.04.3 LTS -amd64</td>
<td>Harbor仓库，未联网</td>
</tr>
</tbody></table>
<p>根据官方文档建议：仓库与集群分离部署，减少相互影响，所以多了一个 registry 服务器。</p>
<p>服务器IP本来想规划成连续着的，后来因为不是一次创建的且此文件不是一次性完成，遂没有关注了。</p>
<p>如果是自己搭建着学习或实验，服务器规格减半也是可以的。</p>
<p>（2）   环境涉及软件版本信息：</p>
<ul>
<li>操作系统：<strong>Ubuntu 20.04.3 LTS -amd64</strong></li>
<li>KubeSphere：<strong>v3.4.1</strong></li>
<li>K8s：<strong>v1.23.17</strong></li>
<li>Docker：<strong>24.0.6</strong></li>
<li>KubeKey: <strong>v3.0.13</strong></li>
<li>Harbor：<strong>2.5.3</strong></li>
</ul>
<h1 id="二、离线安装介绍"><a href="#二、离线安装介绍" class="headerlink" title="二、离线安装介绍"></a>二、离线安装介绍</h1><p>KubeKey 是一个用于部署 Kubernetes 集群的开源轻量级工具。它提供了一种灵活、快速、便捷的方式来仅安装 Kubernetes&#x2F;K3s，或同时安装 Kubernetes&#x2F;K3s 和 KubeSphere，以及其他云原生插件。除此之外，它也是扩展和升级集群的有效工具。</p>
<p>KubeKey v2.1.0 版本新增了清单（manifest）和制品（artifact）的概念，为用户离线部署 Kubernetes 集群提供了一种解决方案。manifest 是一个描述当前 Kubernetes 集群信息和定义 artifact 制品中需要包含哪些内容的文本文件。</p>
<p>使用 KubeKey，用户只需使用清单 manifest 文件来定义将要离线部署的集群环境需要的内容，再通过该 manifest 来导出制品 artifact 文件即可完成准备工作。离线部署时只需要 KubeKey 和 artifact 就可快速、简单的在环境中部署镜像仓库和 Kubernetes 集群。</p>
<p>根据 <a target="_blank" rel="noopener" href="https://www.kubesphere.io/zh/docs/v3.4/installing-on-linux/introduction/air-gapped-installation/">青云官网的离线部署文档</a>，使用生成 manifest 文件有两种方式：</p>
<ul>
<li>参考官方文档，在示例的基础稍作修改（文档中有修改说明）生成满足自己需求的 manifest 文件。</li>
<li>在已有集群中执行 KubeKey 命令生成 manifest 文件，如有需要可再参考官网文档进行修改定制（不修改的话，可想而知生成的制品及最后搭建的环境相关软件版本及镜像跟当前集群一样）。</li>
</ul>
<p>本文中使用第1种方式生成 manifest 文件以及创建后续需要使用到的制品（artifact）。</p>
<p><strong>整个离线部署K8S+KSP的过程的主线就是制作制品、使用制品，其他操作基本上都是围绕它展开的。</strong></p>
<h1 id="三、服务器的前置操作"><a href="#三、服务器的前置操作" class="headerlink" title="三、服务器的前置操作"></a>三、服务器的前置操作</h1><p>建议所有服务器都要执行。</p>
<h2 id="3-1-设置各服务器时区"><a href="#3-1-设置各服务器时区" class="headerlink" title="3.1 设置各服务器时区"></a>3.1 设置各服务器时区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">所有服务器设置时区</span><br>timedatectl set-timezone Asia/Shanghai<br><span class="hljs-meta prompt_">#</span><span class="language-bash">所有未联网服务器关闭网络时间同步</span><br>timedatectl set-ntp false<br><span class="hljs-meta prompt_">#</span><span class="language-bash">所有服务器设置北京时间，尽量相同或靠近</span><br>timedatectl set-time &quot;11:08:30&quot;<br></code></pre></td></tr></table></figure>

<h2 id="3-2-设置各服务器主机名"><a href="#3-2-设置各服务器主机名" class="headerlink" title="3.2 设置各服务器主机名"></a>3.2 设置各服务器主机名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">hostnamectl set-hostname xxx<br><span class="hljs-meta prompt_">#</span><span class="language-bash">然后退出终端并重新创建一个终端会话</span><br></code></pre></td></tr></table></figure>

<h2 id="3-4-安装配置时间同步服务"><a href="#3-4-安装配置时间同步服务" class="headerlink" title="3.4 安装配置时间同步服务"></a>3.4 安装配置时间同步服务</h2><p>强烈建议提前做好如下准备（否则，安装配置时间同步服务无法采用如下方法完成）：</p>
<ul>
<li>搭建操作系统组件安装源仓库</li>
<li>部署了自己的本地NTP服务器</li>
</ul>
<p>一般在搭建软件解决方案前就做好所有服务器的时间同步。如果没有搭建操作系统组件安装源仓库，后面使用kk正式部署k8s+ksp时，也会在所有节点上部署chrony服务，但不会部署本地 NTP服务器。所以还是需要自己提前部署本地 NTP服务器，自己想办法</p>
<h3 id="安装时间同步服务"><a href="#安装时间同步服务" class="headerlink" title="安装时间同步服务"></a>安装时间同步服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">1.安装 chrony 作为时间同步软件</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">正常情况下内网环境下搭建软件解决方案，应该会先自行搭建操作系统组件安装源仓库；</span><br>apt-get install chrony -qy<br></code></pre></td></tr></table></figure>

<h3 id="配置时间同步服务"><a href="#配置时间同步服务" class="headerlink" title="配置时间同步服务"></a>配置时间同步服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">2.修改配置文件 /etc/chrony/chrony.conf，修改 ntp 服务配置</span><br>vi /etc/chrony/chrony.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">将如下认的 pool 配置删除（离线环境中也用不上）</span><br>pool ntp.ubuntu.com        iburst maxsources 4<br>pool 0.ubuntu.pool.ntp.org iburst maxsources 1<br>pool 1.ubuntu.pool.ntp.org iburst maxsources 1<br>pool 2.ubuntu.pool.ntp.org iburst maxsources 2<br><span class="hljs-meta prompt_"># </span><span class="language-bash">然后配置自己本地的NTP服务器（最好是一台可以访问外网的服务器），NTP服务器步骤此文未涉及</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">假如10.13.15.20是本地NTP服务器，则添加如下配置</span><br>server 10.13.15.20 iburst<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">3.重启 chrony 服务：</span><br>systemctl restart chrony<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">4.验证 chrony 同步状态：</span><br>chronyc sourcestats -v<br></code></pre></td></tr></table></figure>

<h2 id="3-5-数据盘配置（可选）"><a href="#3-5-数据盘配置（可选）" class="headerlink" title="3.5 数据盘配置（可选）"></a>3.5 数据盘配置（可选）</h2><p>此次用来搭建k8s环境的三个服务器都配置了一个400G大小的系统盘、一个960G的数据盘。</p>
<p><img src="https://s2.loli.net/2024/09/27/O2KsM3ZyeQWf5wB.png" srcset="/img/loading.gif" lazyload alt="image-20240927113654261"></p>
<p>本文演示每台服务器新增一块数据盘 <strong>&#x2F;dev&#x2F;vdb</strong>（就是说下面的操作要在每个ks8节点服务器上执行）</p>
<h3 id="3-5-1-方法1-裸盘"><a href="#3-5-1-方法1-裸盘" class="headerlink" title="3.5.1 方法1-裸盘"></a>3.5.1 方法1-裸盘</h3><p>将数据盘格式化后挂载到服务器指定目录上（明显，此种方式不支再次扩容），作为 <strong>docker</strong> 和 <strong>Kubernetes Pod</strong> 的专用存储盘（此处应该指明的是笔者得接触到的环境中，业务数据存储一般是对接ceph等独立的分布式存储系统，所以只有日志文件会存储在本地）。</p>
<p>下面是在k8s01-1服务器上操作为例进行阐述，其他节点也需要进行此操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">mklabel 定义分区表格式（常用的有msdos和gpt分区表格式，msdos不支持2TB以上容量的磁盘，所以大于2TB的磁盘选gpt分区表格式）</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mkpart 创建一个分区，名称为data_k8s，此处不支持声明ext4分区格式（所以下行需要用mkfs.ext4），1表示分区起始位置是距离磁盘起始点1 MB，-1表示分区结束位置是磁盘结束位置</span><br>root@k8s01-1:~# parted /dev/vdb -s -- mklabel gpt mkpart data_k8s 1 -1<br><span class="hljs-meta prompt_">#</span><span class="language-bash">将分区格式化为ext4格式</span><br>root@k8s01-1:~# mkfs.ext4 /dev/vdb1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">手动挂载磁盘分区</span><br>root@k8s01-1:/# mkdir /data/<br>root@k8s01-1:/# mount /dev/vdb1 /data/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置开机自动挂载方法1</span><br>root@k8s01-1:/# tail -1 /etc/mtab<br>root@k8s01-1:/# tail -1 /etc/mtab &gt;&gt; /etc/fstab<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置开机自动挂载的第2种方法：可以手动编辑/etc/fstab，添加如下内容</span><br>root@k8s01-1:/# vi /etc/fstab<br>/dev/vdb1 /data ext4 rw,relatime 0 0<br></code></pre></td></tr></table></figure>

<h3 id="3-5-2-方法2-LVM"><a href="#3-5-2-方法2-LVM" class="headerlink" title="3.5.2 方法2-LVM"></a>3.5.2 方法2-LVM</h3><p>以LVM（逻辑卷管理）的方式扩容挂载到服务器指定目录上，作为 <strong>docker</strong> 和 <strong>Kubernetes Pod</strong> 的专用存储盘（此处应该指明的是笔者得接触到的环境中，业务数据存储一般是对接ceph等独立的分布式存储系统，所以只有日志文件会存储在本地）。</p>
<p>下面是在k8s01-1服务器上操作为例进行阐述，其他节点也需要进行此操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建 PV 物理卷</span><br>root@k8s01-1:~# pvcreate /dev/vdb<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建 VG 卷组vgk8s，将物理卷 /dev/vdb 添加到此卷组中。卷组是一种逻辑存储单元，它可以由一个或多个物理卷组成。</span><br>root@k8s01-1:~# vgcreate vgk8s /dev/vdb<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看所有的卷组</span><br>root@k8s01-1:~# vgdisplay<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建 LV 逻辑卷(使用卷组vgk8s的100%所有空间，vgk8s 是VG 名字，lvk8s 是LV 名字)，此处一个逻辑卷对应一个卷组（理论上来说，一个卷组可以被划分为一个或多个逻辑卷）</span><br>root@k8s01-1:~# lvcreate -l 100%VG vgk8s -n lvk8s<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看逻辑卷的挂载目录</span><br>root@k8s01-1:~# lvdisplay<br>...<br>  LV Path                /dev/vgk8s/lvk8s<br>...<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看并格式化逻辑卷</span><br>root@k8s01-1:~# ll /dev/vgk8s/lvk8s<br>root@k8s01-1:~# mkfs.ext4 /dev/vgk8s/lvk8s<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">使用LVM的好处就是后续可以根据需要再向此逻辑卷中增加空间，比如现有需要再增加空间且有一个新的磁盘/dev/vdc</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">但此情况一般不会出现，正如前面所述，业务数据存储一般是对接ceph等独立的分布式存储系统，所以只有日志文件会存储在本地，一般不会需要如此大空间、存储这么久的日志信息（至少笔者未遇到）</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">首先创建物理卷</span><br>root@k8s01-1:~# pvcreate /dev/vdc<br>root@k8s01-1:~# vgextend vgk8s /dev/vdc<br><span class="hljs-meta prompt_">#</span><span class="language-bash">将逻辑卷 /dev/vgk8s/lvk8s 所在卷组（即vgk8s）中所有(100%)剩余可用容量(FREE)扩容给逻辑卷/dev/vgk8s/lvk8s</span><br>root@k8s01-1:~# lvextend -l +100%FREE /dev/vgk8s/lvk8s<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看逻辑卷</span><br>root@k8s01-1:~# lvscan<br>  ACTIVE            &#x27;/dev/vgk8s/lvk8s&#x27; [1.87 TiB] inherit<br><span class="hljs-meta prompt_">#</span><span class="language-bash">或者，使用 lvdisplay 可以看到其更详细的信息</span><br>root@k8s01-1:~# lvdisplay<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">手动挂载逻辑卷</span><br>root@k8s01-1:/# mkdir /data/<br>root@k8s01-1:/# mount /dev/vgk8s/lvk8s /data/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置开机自动挂载方法1</span><br>root@k8s01-1:/# tail -1 /etc/mtab<br>root@k8s01-1:/# tail -1 /etc/mtab &gt;&gt; /etc/fstab<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置开机自动挂载的第2种方法：可以手动编辑/etc/fstab，添加如下内容</span><br>root@k8s01-1:/# vi /etc/fstab<br>/dev/vgk8s/lvk8s /data ext4 rw,relatime 0 0<br></code></pre></td></tr></table></figure>

<h1 id="四、离线部署资源文件制作"><a href="#四、离线部署资源文件制作" class="headerlink" title="四、离线部署资源文件制作"></a>四、离线部署资源文件制作</h1><p>制作离线部署资源文件需要有一个能连接外网的服务器（本文中是prepare），本文中是服务器 <strong>prepare</strong> 。</p>
<p>在该服务器上下载 KubeKey v3.0.13 文件。</p>
<h2 id="4-1-准备-KubeKey-文件"><a href="#4-1-准备-KubeKey-文件" class="headerlink" title="4.1 准备 KubeKey 文件"></a>4.1 准备 KubeKey 文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@prepare:~# mkdir /opt/prepare<br>root@prepare:~# cd /opt/prepare<br><span class="hljs-meta prompt_"># </span><span class="language-bash">选择中文区下载(访问 GitHub 受限时使用)</span><br>root@prepare:/opt/prepare# export KKZONE=cn<br><span class="hljs-meta prompt_"># </span><span class="language-bash">执行下载命令，获取指定版本的 kk（受限于网络，有时需要执行多次）</span><br>root@prepare:/opt/prepare# curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.13 sh -<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@prepare:/opt/prepare# chown root:root kk<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看kubekey3.0.13版本</span><br>root@prepare:/opt/prepare# ./kk version<br>kk version: &amp;version.Info&#123;Major:&quot;3&quot;, Minor:&quot;0&quot;, GitVersion:&quot;v3.0.13&quot;, GitCommit:&quot;ac75d3ef3c22e6a9d999dcea201234d6651b3e72&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2023-11-07T08:42:04Z&quot;, GoVersion:&quot;go1.19.2&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-2-准备-ubuntu-20-04-debs-amd64-iso"><a href="#4-2-准备-ubuntu-20-04-debs-amd64-iso" class="headerlink" title="4.2 准备 ubuntu-20.04-debs-amd64.iso"></a>4.2 准备 ubuntu-20.04-debs-amd64.iso</h2><p>本实验环境使用的操作系统是 x86_64 的 Ubuntu 20.04.3 LTS，所以只下载 Ubuntu 20.04.3 LTS的操作系统依赖组件包，其他操作系统在 <a href="https://link.zhihu.com/?target=https://github.com/kubesphere/kubekey/releases">KubeKey releases 页面</a>下载。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行下面的命令，在能联网的部署服务器上执行下载。网络访问受限时，也可以通过其他方式，将该 ISO 下载后放到制作离线镜像的服务器的 /opt/prepare 目录下。</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">KubeKey v3.0.13 的 release 中没包，只能在 v3.0.12 的 releases 中下载。</span><br>root@prepare:/opt/prepare# wget https://github.com/kubesphere/kubekey/releases/download/v3.0.12/ubuntu-20.04-debs-amd64.iso<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">验证 <span class="hljs-built_in">sha256sum</span>，确保 ISO 在下载过程中没出问题（官方提供的 <span class="hljs-built_in">sha256sum</span> 信息在 https://github.com/kubesphere/kubekey/releases/download/v3.0.12/ubuntu-20.04-debs.iso.sha256sum.txt）</span><br>root@prepare:/opt/prepare# sha256sum ubuntu-20.04-debs-amd64.iso<br>9c35697e4192c57a9195a8d216beda71058a420444c89b895147f27339c369b9  ubuntu-20.04-debs-amd64.iso<br>root@ksp-deploy:/opt/prepare# cat ubuntu-20.04-debs.iso.sha256sum.txt <br>9c35697e4192c57a9195a8d216beda71058a420444c89b895147f27339c369b9  ubuntu-20.04-debs-amd64.iso<br>99152a2675d334cf4d17a32bd99ca1fa21616b5bfe45bb5c93f5175ebca472a0  ubuntu-20.04-debs-arm64.iso<br></code></pre></td></tr></table></figure>

<h2 id="4-3-准备-manifest-文件"><a href="#4-3-准备-manifest-文件" class="headerlink" title="4.3 准备 manifest 文件"></a>4.3 准备 manifest 文件</h2><p>前文已经说过，本文是在官方示例的基础上经过修改生成 manifest 文件。官方示例的话，笔者知道有两个页面可以看到：青云官网的离线部署文档 与 <a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/blob/master/docs/manifest-example.md">manifest-example</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">ksp v3.4.1 对应的完整镜像列表可以通过如下连接下载得到</span><br>root@prepare:/opt/prepare# wget https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/images-list.txt<br><span class="hljs-meta prompt_">#</span><span class="language-bash">但其中包含的是 docker.io 上的镜像，可以在上述“青云官网的离线部署文档https://www.kubesphere.io/zh/docs/v3.4/installing-on-linux/introduction/air-gapped-installation/”中看到其中示例使用的是aliyuncs镜像仓库中的对应镜像，通过参考两处的镜像列表并进行修改，同时修改了镜像列表之外的其他配置，最终得到如下k8sV12317-kspV341-manifest.yaml</span><br><br>root@prepare:/opt/prepare# vi k8sV12317-kspV341-manifest.yaml<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改后的文件内容如下：</span><br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubekey.kubesphere.io/v1alpha2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Manifest</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">sample</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">arches:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">amd64</span><br>  <span class="hljs-attr">operatingSystems:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">arch:</span> <span class="hljs-string">amd64</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">linux</span><br>    <span class="hljs-attr">id:</span> <span class="hljs-string">ubuntu</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">&quot;20.04&quot;</span><br>    <span class="hljs-attr">osImage:</span> <span class="hljs-string">Ubuntu</span> <span class="hljs-number">20.04</span><span class="hljs-number">.3</span> <span class="hljs-string">LTS</span><br>    <span class="hljs-attr">repository:</span><br>      <span class="hljs-attr">iso:</span><br>        <span class="hljs-attr">localPath:</span> <span class="hljs-string">/opt/prepare/ubuntu-20.04-debs-amd64.iso</span><br>        <span class="hljs-attr">url:</span> <br>  <span class="hljs-attr">kubernetesDistributions:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.23.17</span><br>  <span class="hljs-attr">components:</span><br>    <span class="hljs-attr">helm:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">v3.9.0</span><br>    <span class="hljs-attr">cni:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">v1.2.0</span><br>    <span class="hljs-attr">etcd:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">v3.4.13</span><br>    <span class="hljs-attr">calicoctl:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">v3.26.1</span><br>   <span class="hljs-comment">## For now, if your cluster container runtime is containerd, KubeKey will add a docker 20.10.8 container runtime in the below list.</span><br>   <span class="hljs-comment">## The reason is KubeKey creates a cluster with containerd by installing a docker first and making kubelet connect the socket file of containerd which docker contained.</span><br>    <span class="hljs-attr">containerRuntimes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">docker</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-number">24.0</span><span class="hljs-number">.6</span><br>    <span class="hljs-attr">crictl:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">v1.24.0</span><br>    <span class="hljs-attr">docker-registry:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">&quot;2&quot;</span><br>    <span class="hljs-attr">harbor:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">v2.5.3</span><br>    <span class="hljs-attr">docker-compose:</span><br>      <span class="hljs-attr">version:</span> <span class="hljs-string">v2.2.2</span><br>  <span class="hljs-attr">images:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-apiserver:v1.23.17</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controller-manager:v1.23.17</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.23.17</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-scheduler:v1.23.17</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.6</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.26.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.26.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.26.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.26.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/typha:v3.23.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/flannel:v0.12.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/provisioner-localpv:3.3.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/linux-utils:3.3.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/haproxy:2.3</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/nfs-subdir-external-provisioner:v4.0.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.15.12</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/ks-installer:v3.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/ks-apiserver:v3.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/ks-console:v3.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/ks-controller-manager:v3.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kubectl:v1.22.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kubectl:v1.21.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kubectl:v1.20.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kubefed:v0.8.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/tower:v0.2.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/minio:RELEASE.2019-08-07T01-59-21Z</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/mc:RELEASE.2019-08-07T23-14-43Z</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/snapshot-controller:v4.0.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/nginx-ingress-controller:v1.3.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/defaultbackend-amd64:1.4</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/metrics-server:v0.4.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/redis:5.0.14-alpine</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/haproxy:2.0.25-alpine</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/alpine:3.14</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/openldap:1.3.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/netshoot:v1.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/cloudcore:v1.13.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/iptables-manager:v1.13.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/edgeservice:v0.3.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/gatekeeper:v3.5.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/openpitrix-jobs:v3.3.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/devops-apiserver:ks-v3.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/devops-controller:ks-v3.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/devops-tools:ks-v3.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.4.0-2.319.3-1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/inbound-agent:4.10-2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-base:v3.2.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-nodejs:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.1-jdk11</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-python:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.16</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.17</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.18</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-base:v3.2.2-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-nodejs:v3.2.0-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.0-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.1-jdk11-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-python:v3.2.0-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.0-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.16-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.17-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.18-podman</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/s2ioperator:v3.2.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/s2irun:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/s2i-binary:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java11-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java11-runtime:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java8-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java8-runtime:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/java-11-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/java-8-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/java-8-runtime:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/java-11-runtime:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/nodejs-8-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/nodejs-6-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/nodejs-4-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/python-36-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/python-35-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/python-34-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/python-27-centos7:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/argocd:v2.3.3</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/argocd-applicationset:v0.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/dex:v2.30.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/redis:6.2.6-alpine</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/configmap-reload:v0.7.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/prometheus:v2.39.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/prometheus-config-reloader:v0.55.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/prometheus-operator:v0.55.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-rbac-proxy:v0.11.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-state-metrics:v2.6.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/node-exporter:v1.3.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/alertmanager:v0.23.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/thanos:v0.31.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/grafana:8.3.3</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-rbac-proxy:v0.11.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/notification-manager-operator:v2.3.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/notification-manager:v2.3.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/notification-tenant-sidecar:v3.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/elasticsearch-curator:v5.7.6</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/elasticsearch-oss:6.8.22</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/opensearch:2.6.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/opensearch-dashboards:2.6.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/opensearch-curator:v0.0.5</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/fluentbit-operator:v0.14.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/docker:19.03</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/fluent-bit:v1.9.4</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/log-sidecar-injector:v1.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/filebeat:6.7.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-events-operator:v0.6.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-events-exporter:v0.6.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-events-ruler:v0.6.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-auditing-operator:v0.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kube-auditing-webhook:v0.2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/pilot:1.14.6</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/proxyv2:1.14.6</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-operator:1.29</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-agent:1.29</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-collector:1.29</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-query:1.29</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-es-index-cleaner:1.29</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kiali-operator:v1.50.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/kiali:v1.50</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/busybox:1.31.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/nginx:1.14-alpine</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/wget:1.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/hello:plain-text</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/wordpress:4.8-apache</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/hpa-example:latest</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/fluentd:v1.4.2-2.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/perl:latest</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-productpage-v1:1.16.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-reviews-v1:1.16.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-reviews-v2:1.16.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-details-v1:1.16.2</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-ratings-v1:1.16.3</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">registry.cn-beijing.aliyuncs.com/kubesphereio/scope:1.13.0</span><br>  <span class="hljs-attr">kubectl:</span> <span class="hljs-string">v1.22.0</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">auths:</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-4-生成制品文件"><a href="#4-4-生成制品文件" class="headerlink" title="4.4 生成制品文件"></a>4.4 生成制品文件</h2><p>制品（artifact）是一个根据指定的 manifest 文件内容导出的包含镜像 tar 包和相关二进制文件的 tgz 包。  在 KubeKey 初始化镜像仓库、创建集群、添加节点和升级集群的命令中均可指定一个 artifact，KubeKey 将自动解包该 artifact 并在执行命令时直接使用解包出来的文件。</p>
<p><strong>注意</strong></p>
<ul>
<li>导出时请确保网络连接正常（如果中断就需要全部重新来过）。</li>
<li>KubeKey 会解析镜像列表中的镜像名，若镜像名中的镜像仓库需要鉴权信息，可在 manifest 文件中的 <strong>.registry.auths</strong> 字段中进行配置（因为此处使用的是aliyuncs的公共容器镜像，所以无需鉴权）。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">国内一般服务器访问 GitHub/Googleapis 受限，强烈建议执行使用此环境变量</span><br>root@prepare:/opt/prepare# export KKZONE=cn<br><span class="hljs-meta prompt_">#</span><span class="language-bash">根据上述制作的的 manifest，在prepare服务器上执行下面的命令制作制品（artifact）</span><br>root@prepare:/opt/prepare# ./kk artifact export -m k8sV12317-kspV341-manifest.yaml -o k8sV12317-kspV341-artifact.tar.gz<br><span class="hljs-meta prompt_">#</span><span class="language-bash">上述命名执行时，会在当前目录创建一个 kubekey 子目录</span><br></code></pre></td></tr></table></figure>

<p>此命令需要较长时间，执行完成时如下图。</p>
<p><img src="https://s2.loli.net/2025/01/12/h9FTtslICbfSEJa.png" srcset="/img/loading.gif" lazyload alt="image-20250112124715488"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">制作过程中，创建 kubekey/artifact目录其中存放临时下载的文件与镜像，制品制作完成后 kubekey/artifact 目录会被清理</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">制作完成后，会在当前目录生成一个 k8sV12317-kspV341-artifact.tar.gz 文件</span><br>root@prepare:/opt/prepare# ls -alh k8sV12317-kspV341-artifact.tar.gz<br>-rw-r--r-- 1 root root 13G Jan 12 12:41 k8sV12317-kspV341-artifact.tar.gz<br></code></pre></td></tr></table></figure>

<h2 id="4-5-离线部署资源文件汇总"><a href="#4-5-离线部署资源文件汇总" class="headerlink" title="4.5 离线部署资源文件汇总"></a>4.5 离线部署资源文件汇总</h2><p>至此，我们已经准备了如下两个离线部署文件：</p>
<ul>
<li>KubeKey：<strong>kubekey-v3.0.13-linux-amd64.tar.gz（35M）</strong></li>
<li>制品artifact：<strong>k8sV12317-kspV341-artifact.tar.gz（13G）</strong></li>
</ul>
<h1 id="五、离线部署执行前准备"><a href="#五、离线部署执行前准备" class="headerlink" title="五、离线部署执行前准备"></a>五、离线部署执行前准备</h1><h2 id="5-1-上传离线部署资源文件"><a href="#5-1-上传离线部署资源文件" class="headerlink" title="5.1 上传离线部署资源文件"></a>5.1 上传离线部署资源文件</h2><p>将 KubeKey 和制品 artifact ，上传至离线环境部署节点 (此处是 <strong>k8s01-1</strong> 节点，所有节点信息参考文档最开始处的描述) 的 &#x2F;opt&#x2F; 目录。</p>
<ul>
<li>KubeKey：<strong>kubekey-v3.0.13-linux-amd64.tar.gz（35M）</strong></li>
<li>制品artifact：<strong>k8sV12317-kspV341-artifact.tar.gz（13G）</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建离线资源存放的数据目录</span><br>root@k8s01-1:/# mkdir /opt/offline-deployk8sksp<br><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令，解压 KubeKey：</span><br>root@k8s01-1:/# mv /opt/k8sV12317-kspV341-artifact.tar.gz /opt/offline-deployk8sksp<br>root@k8s01-1:/# tar -zxf /opt/kubekey-v3.0.13-linux-amd64.tar.gz -C /opt/offline-deployk8sksp<br>root@k8s01-1:/# cd /opt/offline-deployk8sksp<br></code></pre></td></tr></table></figure>

<h2 id="5-2-创建离线集群配置文件"><a href="#5-2-创建离线集群配置文件" class="headerlink" title="5.2 创建离线集群配置文件"></a>5.2 创建离线集群配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令创建离线集群配置文件</span><br>root@k8s01-1:/opt/offline-deployk8sksp# ./kk create config --with-kubesphere v3.4.1 --with-kubernetes v1.23.17 -f k8sV12317-kspV341-offlineconfig.yaml<br></code></pre></td></tr></table></figure>

<p>命令执行成功后，在同目录会生成一个 k8sV12317-kspV341-offlineconfig.yaml 文件。</p>
<h2 id="5-3-修改-K8S-部署相关配置"><a href="#5-3-修改-K8S-部署相关配置" class="headerlink" title="5.3 修改 K8S 部署相关配置"></a>5.3 修改 K8S 部署相关配置</h2><p>k8sV12317-kspV341-offlineconfig.yaml 文件中 <strong>“kind: Cluster”</strong> 部分是部署 k8s 集群的相关配置，只需要修改 spec 内的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@k8s01-1:/opt/offline-deployk8sksp# vi k8sV12317-kspV341-offlineconfig.yaml<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改离线集群配置文件 k8sV12317-kspV341-offlineconfig.yaml，修改说明及修改后的截图如下</span><br></code></pre></td></tr></table></figure>

<p>spec 内需要修改处说明如下（其余未说明处保持默认）：</p>
<ul>
<li>hosts部分：指定所有k8s节点的主机主机名、 IP、用户、密码此外还新增一个 registry 节点的配置</li>
<li>roleGroups部分：指定 3 个节点同时作为 etcd、control-plane 和 worker 节点，同时还有一个服务器k8s01-4只做工作节点。另外 <code>registry</code> 部分指定镜像仓库的服务器主机名，用于 KubeKey 部署自建 Harbor 仓库</li>
<li>controlPlaneEndpoint部分： 启用并设置内置的负载均衡器（internalLoadbalancer）为 HAProxy</li>
<li>新增了storage.openebs.basePath 部分：指定 openebs 默认存储路径（就是默认创建的sc&#x2F;local的存储路径）为 <strong>&#x2F;data&#x2F;openebs&#x2F;local</strong></li>
<li>registry：添加 type 类型为 harbor，否则后面执行“init registry”时会安装 docker registry 作为镜像仓库，还有<code>auths</code>部分与<code>privateRegistry</code>与<code>namespaceOverride</code>参数（auths部分有参考： <a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/blob/master/docs/config-example.md">kubesphere关于部署配置文件的描述</a>）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs shell">apiVersion: kubekey.kubesphere.io/v1alpha2<br>kind: Cluster<br>metadata:<br>  name: sample<br>spec:<br>  hosts:<br>  - &#123;name: k8s01-1, address: 10.13.15.16, internalAddress: 10.13.15.16, user: root, password: &quot;cloud@2020&quot;&#125;<br>  - &#123;name: k8s01-2, address: 10.13.15.17, internalAddress: 10.13.15.17, user: root, password: &quot;cloud@2020&quot;&#125;<br>  - &#123;name: k8s01-3, address: 10.13.15.161, internalAddress: 10.13.15.161, user: root, password: &quot;cloud@2020&quot;&#125;<br>  - &#123;name: k8s01-4, address: 10.13.15.99, internalAddress: 10.13.15.99, user: root, password: &quot;cloud@2020&quot;&#125;<br>  - &#123;name: registry, address: 10.13.15.71, internalAddress: 10.13.15.71, user: root, password: &quot;cloud@2020&quot;&#125;<br>  roleGroups:<br>    etcd:<br>    - k8s01-1<br>    - k8s01-2<br>    - k8s01-3<br>    control-plane:<br>    - k8s01-1<br>    - k8s01-2<br>    - k8s01-3<br>    worker:<br>    - k8s01-1<br>    - k8s01-2<br>    - k8s01-3<br>    - k8s01-4<br>    registry:    # 如需使用 kk 自动部署镜像仓库，请设置该主机组 （建议仓库与集群分离部署，减少相互影响）<br>    - registry<br>  controlPlaneEndpoint:<br>    ## Internal loadbalancer for apiservers <br>    internalLoadbalancer: haproxy<br><br>    domain: lb.kubesphere.local<br>    address: &quot;&quot;<br>    port: 6443<br>  kubernetes:<br>    version: v1.23.17<br>    clusterName: cluster.local<br>    autoRenewCerts: true<br>    containerManager: docker<br>  etcd:<br>    type: kubekey<br>  network:<br>    plugin: calico<br>    kubePodsCIDR: 10.233.64.0/18<br>    kubeServiceCIDR: 10.233.0.0/18<br>    ## multus support. https://github.com/k8snetworkplumbingwg/multus-cni<br>    multusCNI:<br>      enabled: false<br>  storage:<br>    openebs:<br>      basePath: /data/openebs/local # 默认没有的新增配置，base path of the local PV provisioner<br>  registry:<br>    # 如需使用 kk 部署 harbor, 可将该参数设置为 harbor，不设置该参数且需使用 kk 创建容器镜像仓库，将默认使用docker registry。<br>    type: harbor<br>    # 如使用 kk 部署的 harbor 或其他需要登录的仓库，可设置对应仓库的auths，如使用 kk 创建的 docker registry 仓库，则无需配置该参数。<br>    # 注意：如使用 kk 部署 harbor，该参数请于 harbor 启动后设置。<br>    #auths:<br>    #  &quot;registry.syjiang.com&quot;:<br>    #    username: admin<br>    #    password: Harbor12345<br>    #    certsPath: &quot;/etc/docker/certs.d/registry.syjiang.com&quot;<br>    #    skipTLSVerify: false # 即使 TLS校验失败了，仍允许通过HTTPS协议连接registry<br>    #    plainHTTP: false # 允许通过HTTP协议连接registry<br>    # 设置集群部署时使用的私有仓库<br>    privateRegistry: &quot;registry.syjiang.com&quot;<br>    namespaceOverride: &quot;kubesphereio&quot;<br>    registryMirrors: []<br>    insecureRegistries: []<br>  addons: []<br></code></pre></td></tr></table></figure>

<h2 id="5-4-修改-KSP-部署相关配置"><a href="#5-4-修改-KSP-部署相关配置" class="headerlink" title="5.4 修改 KSP 部署相关配置"></a>5.4 修改 KSP 部署相关配置</h2><p>k8sV12317-kspV341-offlineconfig.yaml 文件中 <strong>kind: ClusterConfiguration</strong> 部分是关于部署 KubeSphere 及相关插件的配置。</p>
<h3 id="5-4-1-必须要新增的参数"><a href="#5-4-1-必须要新增的参数" class="headerlink" title="5.4.1 必须要新增的参数"></a>5.4.1 必须要新增的参数</h3><ul>
<li>添加ClusterConfiguration.spec.namespace_override参数</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">82 spec:<br>83   namespace_override: &quot;kubesphereio&quot;<br></code></pre></td></tr></table></figure>

<p>此参数的意义跟K8S部署配置中的<code>spec.registry.namespaceOverride</code>类似，要确认是配置成 <strong><code>kubesphereio</code></strong>，且要加双引号（笔者先前没加双引号时没生效，但kubesphere官方cnblogs博客文章中是没有加双引号的）。它的作用就是<code>Kubesphere</code>本身使用到的镜像只到**<code>registry.syjiang.com/kubesphereio</code><strong>下面去拉取，如果不配置的话有些镜像是会到另外的项目下拉取的比如<code>kubesphere-system</code>空间中<code>pod/ks-apiserver-xxx</code>用到的镜像就是</strong><code>registry.syjiang.com/kubesphere/ks-apiserver:v3.4.1</code>**。</p>
<p>据Kubeshpere的官方博文介绍，2.x 版本的 KubeKey 没这个问题，3.x 的到 v3.1.1 为止，都存在这个问题。</p>
<h3 id="5-4-2-可修改的参数（可选）"><a href="#5-4-2-可修改的参数（可选）" class="headerlink" title="5.4.2 可修改的参数（可选）"></a>5.4.2 可修改的参数（可选）</h3><p>前面准备的制品文件非常之大有10多G，就是因为其中包含相关可选组件的全量镜像。如果不想启用可选插件，这部分直接保持默认配置也可。</p>
<p>如果有需要或想学习一下，可以启用相关插件配置。以下是启用了除 Kubeedge 、gatekeeper 以外的所有插件后的配置（很多内容笔者并没有用过，只是参考了kubesphere在cnblogs上的博文 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/kubesphere/p/18208852">一文搞定 KubeKey 3.1.1 离线部署 KubeSphere 3.4.1 和 Kubernetes v1.28</a>）。</p>
<ul>
<li>启用 etcd 监控</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">90   etcd:<br>91     monitoring: true #将false改为true<br>92     endpointIps: localhost<br>93     port: 2379<br>94     tlsEnable: true<br></code></pre></td></tr></table></figure>

<ul>
<li>启用 KubeSphere 告警系统</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">162   alerting:<br>163     enabled: true #将false改为true<br>164     # thanosruler:<br>165     #   replicas: 1<br>166     #   resources: &#123;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>启用 KubeSphere 审计日志</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">167   auditing:<br>168     enabled: true #将false改为true<br>169     # operator:<br>170     #   resources: &#123;&#125;<br>171     # webhook:<br>172     #   resources: &#123;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>启用 KubeSphere DevOps 系统</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">173   devops:<br>174     enabled: true #将false改为true<br>175     jenkinsCpuReq: 0.5<br>176     jenkinsCpuLim: 1<br>177     jenkinsMemoryReq: 4Gi<br>178     jenkinsMemoryLim: 4Gi<br>179     jenkinsVolumeSize: 16Gi<br></code></pre></td></tr></table></figure>

<ul>
<li>启用 KubeSphere 事件系统</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">180   events:<br>181     enabled: true #将false改为true<br>182     # operator:<br>183     #   resources: &#123;&#125;<br>184     # exporter:<br>185     #   resources: &#123;&#125;<br>186     ruler:<br>187       enabled: true<br>188       replicas: 2<br>189     #   resources: &#123;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>启用 KubeSphere 日志系统（v3.4.0 开始默认启用 opensearch）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">190   logging:<br>191     enabled: true #将false改为true<br>192     logsidecar:<br>193       enabled: true<br>194       replicas: 2<br>195       # resources: &#123;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>启用 Metrics Server</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">196   metrics_server:<br>197     enabled: true #将false改为true<br></code></pre></td></tr></table></figure>

<p>**说明：*<em>KubeSphere 支持用于</em>deployments*的容器组（Pod）弹性伸缩程序 (HPA)。在 KubeSphere 中，Metrics Server 控制着 HPA 是否启用。</p>
<ul>
<li>启用网络策略、容器组 IP 池，服务拓扑图</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">228   network:<br>229     networkpolicy:<br>230       enabled: true #将false改为true<br>231     ippool:<br>232       type: calico #将none改为 calico<br>233     topology:<br>234       type: weave-scope #将none 改为 weave-scope<br></code></pre></td></tr></table></figure>

<ul>
<li>启用应用商店</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">235   openpitrix:<br>236     store:<br>237       enabled: true #将false改为true<br></code></pre></td></tr></table></figure>

<ul>
<li>启用 KubeSphere 服务网格（Istio）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">238   servicemesh:<br>239     enabled: true #将false改为true<br>240     istio:<br>241       components:<br>242         ingressGateways:<br>243         - name: istio-ingressgateway<br>244           enabled: false<br>245         cni:<br>246           enabled: false<br></code></pre></td></tr></table></figure>

<p>此时，修改后的 k8sV12317-kspV341-offlineconfig.yaml 文件完整内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubekey.kubesphere.io/v1alpha2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">sample</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">hosts:</span><br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">k8s01-1</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.16</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.16</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@2020&quot;</span>&#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">k8s01-2</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.17</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.17</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@2020&quot;</span>&#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">k8s01-3</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.161</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.161</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@2020&quot;</span>&#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">k8s01-4</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.99</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.99</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@2020&quot;</span>&#125;<br>  <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">registry</span>, <span class="hljs-attr">address:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.71</span>, <span class="hljs-attr">internalAddress:</span> <span class="hljs-number">10.13</span><span class="hljs-number">.15</span><span class="hljs-number">.71</span>, <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;cloud@2020&quot;</span>&#125;<br>  <span class="hljs-attr">roleGroups:</span><br>    <span class="hljs-attr">etcd:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-3</span><br>    <span class="hljs-attr">control-plane:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-3</span><br>    <span class="hljs-attr">worker:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-3</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s01-4</span><br>    <span class="hljs-attr">registry:</span>    <span class="hljs-comment"># 如需使用 kk 自动部署镜像仓库，请设置该主机组 （建议仓库与集群分离部署，减少相互影响）</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">registry</span><br>  <span class="hljs-attr">controlPlaneEndpoint:</span><br>    <span class="hljs-comment">## Internal loadbalancer for apiservers </span><br>    <span class="hljs-attr">internalLoadbalancer:</span> <span class="hljs-string">haproxy</span><br><br>    <span class="hljs-attr">domain:</span> <span class="hljs-string">lb.kubesphere.local</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6443</span><br>  <span class="hljs-attr">kubernetes:</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.23.17</span><br>    <span class="hljs-attr">clusterName:</span> <span class="hljs-string">cluster.local</span><br>    <span class="hljs-attr">autoRenewCerts:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">containerManager:</span> <span class="hljs-string">docker</span><br>  <span class="hljs-attr">etcd:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">kubekey</span><br>  <span class="hljs-attr">network:</span><br>    <span class="hljs-attr">plugin:</span> <span class="hljs-string">calico</span><br>    <span class="hljs-attr">kubePodsCIDR:</span> <span class="hljs-number">10.233</span><span class="hljs-number">.64</span><span class="hljs-number">.0</span><span class="hljs-string">/18</span><br>    <span class="hljs-attr">kubeServiceCIDR:</span> <span class="hljs-number">10.233</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/18</span><br>    <span class="hljs-comment">## multus support. https://github.com/k8snetworkplumbingwg/multus-cni</span><br>    <span class="hljs-attr">multusCNI:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">storage:</span><br>    <span class="hljs-attr">openebs:</span><br>      <span class="hljs-attr">basePath:</span> <span class="hljs-string">/data/openebs/local</span> <span class="hljs-comment"># 默认没有的新增配置，base path of the local PV provisioner</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-comment"># 如需使用 kk 部署 harbor, 可将该参数设置为 harbor，不设置该参数且需使用 kk 创建容器镜像仓库，将默认使用docker registry。</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">harbor</span><br>    <span class="hljs-comment"># 如使用 kk 部署的 harbor 或其他需要登录的仓库，可设置对应仓库的auths，如使用 kk 创建的 docker registry 仓库，则无需配置该参数。</span><br>    <span class="hljs-comment"># 注意：如使用 kk 部署 harbor，该参数请于 harbor 启动后设置。</span><br>    <span class="hljs-comment">#auths:</span><br>    <span class="hljs-comment">#  &quot;registry.syjiang.com&quot;:</span><br>    <span class="hljs-comment">#    username: admin</span><br>    <span class="hljs-comment">#    password: Harbor12345</span><br>    <span class="hljs-comment">#    certsPath: &quot;/etc/docker/certs.d/registry.syjiang.com&quot;</span><br>    <span class="hljs-comment">#    skipTLSVerify: false # 即使 TLS校验失败了，仍允许通过HTTPS协议连接registry</span><br>    <span class="hljs-comment">#    plainHTTP: false # 允许通过HTTP协议连接registry</span><br>    <span class="hljs-comment"># 设置集群部署时使用的私有仓库</span><br>    <span class="hljs-attr">privateRegistry:</span> <span class="hljs-string">&quot;registry.syjiang.com&quot;</span><br>    <span class="hljs-attr">namespaceOverride:</span> <span class="hljs-string">&quot;kubesphereio&quot;</span><br>    <span class="hljs-attr">registryMirrors:</span> []<br>    <span class="hljs-attr">insecureRegistries:</span> []<br>  <span class="hljs-attr">addons:</span> []<br><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">installer.kubesphere.io/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubesphere-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v3.4.1</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">namespace_override:</span> <span class="hljs-string">&quot;kubesphereio&quot;</span><br>  <span class="hljs-attr">persistence:</span><br>    <span class="hljs-attr">storageClass:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">authentication:</span><br>    <span class="hljs-attr">jwtSecret:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">local_registry:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-comment"># dev_tag: &quot;&quot;</span><br>  <span class="hljs-attr">etcd:</span><br>    <span class="hljs-attr">monitoring:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-attr">endpointIps:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">2379</span><br>    <span class="hljs-attr">tlsEnable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">common:</span><br>    <span class="hljs-attr">core:</span><br>      <span class="hljs-attr">console:</span><br>        <span class="hljs-attr">enableMultiLogin:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">30880</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>    <span class="hljs-comment"># apiserver:</span><br>    <span class="hljs-comment">#  resources: &#123;&#125;</span><br>    <span class="hljs-comment"># controllerManager:</span><br>    <span class="hljs-comment">#  resources: &#123;&#125;</span><br>    <span class="hljs-attr">redis:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">enableHA:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">volumeSize:</span> <span class="hljs-string">2Gi</span><br>    <span class="hljs-attr">openldap:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">volumeSize:</span> <span class="hljs-string">2Gi</span><br>    <span class="hljs-attr">minio:</span><br>      <span class="hljs-attr">volumeSize:</span> <span class="hljs-string">20Gi</span><br>    <span class="hljs-attr">monitoring:</span><br>      <span class="hljs-comment"># type: external</span><br>      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span><br>      <span class="hljs-attr">GPUMonitoring:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">gpu:</span><br>      <span class="hljs-attr">kinds:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">resourceName:</span> <span class="hljs-string">&quot;nvidia.com/gpu&quot;</span><br>        <span class="hljs-attr">resourceType:</span> <span class="hljs-string">&quot;GPU&quot;</span><br>        <span class="hljs-attr">default:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">es:</span><br>      <span class="hljs-comment"># master:</span><br>      <span class="hljs-comment">#   volumeSize: 4Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-comment"># data:</span><br>      <span class="hljs-comment">#   volumeSize: 20Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">logMaxAge:</span> <span class="hljs-number">7</span><br>      <span class="hljs-attr">elkPrefix:</span> <span class="hljs-string">logstash</span><br>      <span class="hljs-attr">basicAuth:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalElasticsearchHost:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalElasticsearchPort:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">opensearch:</span><br>      <span class="hljs-comment"># master:</span><br>      <span class="hljs-comment">#   volumeSize: 4Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-comment"># data:</span><br>      <span class="hljs-comment">#   volumeSize: 20Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">logMaxAge:</span> <span class="hljs-number">7</span><br>      <span class="hljs-attr">opensearchPrefix:</span> <span class="hljs-string">whizard</span><br>      <span class="hljs-attr">basicAuth:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;admin&quot;</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;admin&quot;</span><br>      <span class="hljs-attr">externalOpensearchHost:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalOpensearchPort:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">dashboard:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">alerting:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-comment"># thanosruler:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">auditing:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-comment"># operator:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># webhook:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">devops:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-attr">jenkinsCpuReq:</span> <span class="hljs-number">0.5</span><br>    <span class="hljs-attr">jenkinsCpuLim:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">jenkinsMemoryReq:</span> <span class="hljs-string">4Gi</span><br>    <span class="hljs-attr">jenkinsMemoryLim:</span> <span class="hljs-string">4Gi</span><br>    <span class="hljs-attr">jenkinsVolumeSize:</span> <span class="hljs-string">16Gi</span><br>  <span class="hljs-attr">events:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-comment"># operator:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># exporter:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-attr">ruler:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">logging:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-attr">logsidecar:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>      <span class="hljs-comment"># resources: &#123;&#125;</span><br>  <span class="hljs-attr">metrics_server:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>  <span class="hljs-attr">monitoring:</span><br>    <span class="hljs-attr">storageClass:</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">node_exporter:</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9100</span><br>      <span class="hljs-comment"># resources: &#123;&#125;</span><br>    <span class="hljs-comment"># kube_rbac_proxy:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># kube_state_metrics:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># prometheus:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   volumeSize: 20Gi</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   operator:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-comment"># alertmanager:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># notification_manager:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   operator:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   proxy:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-attr">gpu:</span><br>      <span class="hljs-attr">nvidia_dcgm_exporter:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>  <span class="hljs-attr">multicluster:</span><br>    <span class="hljs-attr">clusterRole:</span> <span class="hljs-string">none</span><br>  <span class="hljs-attr">network:</span><br>    <span class="hljs-attr">networkpolicy:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-attr">ippool:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">calico</span> <span class="hljs-comment">#将none改为 calico</span><br>    <span class="hljs-attr">topology:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">weave-scope</span> <span class="hljs-comment">#将none 改为 weave-scope</span><br>  <span class="hljs-attr">openpitrix:</span><br>    <span class="hljs-attr">store:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>  <span class="hljs-attr">servicemesh:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#将false改为true</span><br>    <span class="hljs-attr">istio:</span><br>      <span class="hljs-attr">components:</span><br>        <span class="hljs-attr">ingressGateways:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">istio-ingressgateway</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">cni:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">edgeruntime:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">kubeedge:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">cloudCore:</span><br>        <span class="hljs-attr">cloudHub:</span><br>          <span class="hljs-attr">advertiseAddress:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-attr">service:</span><br>          <span class="hljs-attr">cloudhubNodePort:</span> <span class="hljs-string">&quot;30000&quot;</span><br>          <span class="hljs-attr">cloudhubQuicNodePort:</span> <span class="hljs-string">&quot;30001&quot;</span><br>          <span class="hljs-attr">cloudhubHttpsNodePort:</span> <span class="hljs-string">&quot;30002&quot;</span><br>          <span class="hljs-attr">cloudstreamNodePort:</span> <span class="hljs-string">&quot;30003&quot;</span><br>          <span class="hljs-attr">tunnelNodePort:</span> <span class="hljs-string">&quot;30004&quot;</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>        <span class="hljs-comment"># hostNetWork: false</span><br>      <span class="hljs-attr">iptables-manager:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-string">&quot;external&quot;</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>      <span class="hljs-comment"># edgeService:</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">gatekeeper:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># controller_manager:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># audit:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">terminal:</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">600</span><br></code></pre></td></tr></table></figure>

<h2 id="5-5-创建配置数据目录"><a href="#5-5-创建配置数据目录" class="headerlink" title="5.5 创建配置数据目录"></a>5.5 创建配置数据目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">集群所有节点都操作</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建 openebs 本地数据根目录</span><br>root@k8s01-1:/# mkdir -p /data/openebs/local<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建 docker 数据目录</span><br>root@k8s01-1:/# mkdir -p /data/docker<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建 docker数据目录软连接</span><br>root@k8s01-1:/# ln -s /data/docker /var/lib/docker<br></code></pre></td></tr></table></figure>

<h2 id="5-6-安装依赖组件"><a href="#5-6-安装依赖组件" class="headerlink" title="5.6 安装依赖组件"></a>5.6 安装依赖组件</h2><p>使用Kubekey在线方式部署k8s+ksp时，需要使用执行”.&#x2F;kk cluster xxx”之前安装操作系统依赖组件，部署过程中校验其未安装就报错而中断部署。但离线部署时，通过给kk 传递“-a k8sV12317-kspV341-artifact.tar.gz”参数可以自动完成这些依赖组件的安装。</p>
<p>所以此处无需手动操作。</p>
<h2 id="5-7、安装配置-Harbor"><a href="#5-7、安装配置-Harbor" class="headerlink" title="5.7、安装配置 Harbor"></a>5.7、安装配置 Harbor</h2><p>采用 KubeKey 工具在 registry 服务器上部署 Harbor、创建项目、向其中推送镜像。</p>
<p>请注意，以下操作涉及到两个服务器（<code>k8s01-1</code>是部署节点，<code>registry</code>是Harbor服务所在服务器）且可能会来回切换，请根据命令前的主机名进行区分具体是在哪个服务器上执行相关命令。上执行。</p>
<h3 id="5-7-1-安装-Harbor"><a href="#5-7-1-安装-Harbor" class="headerlink" title="5.7.1 安装 Harbor"></a>5.7.1 安装 Harbor</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在部署节点执行如下命令，安装镜像仓库（本文中是 Harbor）</span><br>root@k8s01-1:/opt/offline-deployk8sksp# ./kk init registry -f k8sV12317-kspV341-offlineconfig.yaml -a k8sV12317-kspV341-artifact.tar.gz<br></code></pre></td></tr></table></figure>

<p>此处一定不要将k8s01-1节点（其他k8s节点笔者没有尝试，不知是否会报类似错误，可能需要查看kk源码才知道具体的逻辑）同时作为Harbor 服务所在服务器，否则将提示找不到“&#x2F;tmp&#x2F;kubekey&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;registry.syjiang.com&#x2F;ca.crt”而中断执行：</p>
<p><img src="https://s2.loli.net/2025/01/12/9DOjugW2Gxcdsvy.png" srcset="/img/loading.gif" lazyload alt="image-20250112161653908"></p>
<p>可以看到在安装harbor过程中会做如下事情：</p>
<ul>
<li>为所有节点配置ntp服务器（这个ntp服务器在哪里，还不确定）</li>
<li>推送私有证书到registry服务器</li>
<li>在registry服务器上安装docker、安装docker-compose、启动harbor</li>
</ul>
<p><img src="https://s2.loli.net/2025/01/12/jLsZ9bpvfydHUGq.png" srcset="/img/loading.gif" lazyload alt="image-20250112162718819"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在registry服务器查看（harbor的安装文件与配置文件默认被放置在 /opt/harbor 目录）</span><br>root@registry:~# ls -lh /opt/harbor/<br>total 633M<br>-rw-r--r-- 1 root root  12K Jul  7  2022 LICENSE<br>drwxr-xr-x 3 root root 4.0K Jan 12 16:26 common<br>-rw-r--r-- 1 root root 3.3K Jul  7  2022 common.sh<br>-rw-r--r-- 1 root root 9.3K Jan 12 16:26 docker-compose.yml<br>-rw-r--r-- 1 root root 633M Jul  7  2022 harbor.v2.5.3.tar.gz<br>-rw-r--r-- 1 root root 3.4K Jan 12 16:25 harbor.yml<br>-rw-r--r-- 1 root root 9.7K Jul  7  2022 harbor.yml.tmpl<br>-rwxr-xr-x 1 root root 2.5K Jul  7  2022 install.sh<br>-rwxr-xr-x 1 root root 1.9K Jul  7  2022 prepare<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看容器列表</span><br>root@registry:~# cd /opt/harbor/<br>root@registry:/opt/harbor# docker-compose ps -a<br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2025/01/12/ZPpxCvWJHVTFGNo.png" srcset="/img/loading.gif" lazyload alt="image-20250112163452340"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看 /opt/harbor/harbor.yml 配置的域名</span><br>root@registry:/opt/harbor# cat /opt/harbor/harbor.yml | grep hostname:<br>hostname: registry.syjiang.com<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看 Docker 是否配置了私有证书</span><br>root@registry:/opt/harbor# ll /etc/docker/certs.d<br>total 12<br>drwxr-xr-x 3 root root 4096 Jan 12 16:24 ./<br>drwxr-xr-x 3 root root 4096 Jan 12 16:24 ../<br>drwxrwxr-x 2 root root 4096 Jan 12 16:24 registry.syjiang.com/<br>root@registry:/opt/harbor# ll /etc/docker/certs.d/registry.syjiang.com/<br>total 20<br>drwxrwxr-x 2 root root 4096 Jan 12 16:24 ./<br>drwxr-xr-x 3 root root 4096 Jan 12 16:24 ../<br>-rw-r--r-- 1 root root 1103 Jan 12 16:24 ca.crt<br>-rw-r--r-- 1 root root 1249 Jan 12 16:24 registry.syjiang.com.cert<br>-rw------- 1 root root 1675 Jan 12 16:24 registry.syjiang.com.key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">KubeKey 部署 Harbor 时，在registry服务器上安装docker、docker-compose、同步私有证书</span><br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">k8s集群所有节点此时还不会安装docker，但会创建 /etc/docker/certs.d 目录并同步私有证书</span><br>root@k8s01-1:/opt/offline-deployk8sksp# ll /etc/docker/certs.d<br>total 12<br>drwxr-xr-x 3 root root 4096 Jan 12 16:24 ./<br>drwxr-xr-x 3 root root 4096 Jan 12 16:24 ../<br>drwxrwxr-x 2 root root 4096 Jan 12 16:24 registry.syjiang.com/<br>root@k8s01-1:/opt/offline-deployk8sksp# ll /etc/docker/certs.d/registry.syjiang.com/<br>total 20<br>drwxrwxr-x 2 root root 4096 Jan 12 16:24 ./<br>drwxr-xr-x 3 root root 4096 Jan 12 16:24 ../<br>-rw-r--r-- 1 root root 1103 Jan 12 16:24 ca.crt<br>-rw-r--r-- 1 root root 1249 Jan 12 16:24 registry.syjiang.com.cert<br>-rw------- 1 root root 1675 Jan 12 16:24 registry.syjiang.com.key<br></code></pre></td></tr></table></figure>

<h3 id="5-7-2-在-Harbor-中创建项目"><a href="#5-7-2-在-Harbor-中创建项目" class="headerlink" title="5.7.2 在 Harbor 中创建项目"></a>5.7.2 在 Harbor 中创建项目</h3><p>由于 <code>Harbor</code>项目存在访问控制（<code>RBAC</code>）的限制，即只有指定角色的用户才能执行某些操作。如果未创建项目，则镜像不能被推送到 Harbor。</p>
<p><code>Harbor </code>中有两种类型的项目：</p>
<ul>
<li>公共项目（Public）：任何用户都可以从这个项目中拉取镜像。</li>
<li>私有项目（Private）：只有作为项目成员的用户可以拉取镜像。</li>
</ul>
<p>使用 KubeKey 作为工具来部署的 Harbor 镜像仓库的一些默认信息如下：</p>
<ul>
<li><code>Harbor</code> 管理员账号：<strong>admin</strong>，密码：<strong>Harbor12345</strong>。</li>
<li><code>Harbor</code> 安装与配置文件在registry服务器的 <strong>&#x2F;opt&#x2F;harbor</strong> 目录,  如需运维 Harbor，可至该目录下。</li>
</ul>
<p>目前我们只是在<code>registry</code>服务器上部署了<code>Harbor</code>镜像仓库，此时只有一个默认的<code>library</code>项目，其余内容是空的。还需要进一步进行配置以作为离线部署k8s+ksp环境时使用的镜像仓库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令下载指定脚本，后面用来初始化 Harbor 仓库（但使用时发现其中少了一个项目 kubesphereio ）</span><br>root@registry:/opt/harbor# wget https://raw.githubusercontent.com/kubesphere/ks-installer/master/scripts/create_project_harbor.sh<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">于是结合 https://www.kubesphere.io/zh/docs/v3.4/installing-on-linux/introduction/air-gapped-installation/#%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4 此文档中给出的create_project_harbor.sh 示例，将两者进行合并，修改得到如下 create_project_harbor.sh 文件</span><br></code></pre></td></tr></table></figure>

<p>修改点包含如下：</p>
<ul>
<li>修改 <strong>url</strong> 的值为 <strong><a target="_blank" rel="noopener" href="https://registry.syjiang.com/">https://registry.syjiang.com</a></strong>。</li>
<li>需要指定仓库项目名称列表，包含镜像列表（manifest文件的镜像列表）中的项目名称。</li>
<li>脚本末尾 <code>curl</code> 命令末尾加上 <code>-k</code>，表示允许不使用证书到SSL站点。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">合并与修改后，最终得到的 create_project_harbor.sh 文件内容如下</span><br>root@registry:/opt/harbor# cat create_project_harbor.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/usr/bin/env bash</span><br><br>url=&quot;https://registry.syjiang.com&quot;<br>user=&quot;admin&quot;<br>passwd=&quot;Harbor12345&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">此处其实有点奇怪，后面其实将所有镜像只推送到 kubesphereio 这一个项目下。但此处又列表了26个项目，不知道青云的kk工具是不是有其他设计还没有实现</span><br>harbor_projects=(<br>    library<br>    kubesphereio<br>    kubesphere<br>    argoproj<br>    calico<br>    coredns<br>    openebs<br>    csiplugin<br>    minio<br>    mirrorgooglecontainers<br>    osixia<br>    prom<br>    thanosio<br>    jimmidyson<br>    grafana<br>    elastic<br>    istio<br>    jaegertracing<br>    jenkins<br>    weaveworks<br>    openpitrix<br>    joosthofman<br>    nginxdemos<br>    fluent<br>    kubeedge<br>    openpolicyagent<br>)<br><br>for project in &quot;$&#123;harbor_projects[@]&#125;&quot;; do<br>    echo &quot;creating $project&quot;<br>    curl -u &quot;$&#123;user&#125;:$&#123;passwd&#125;&quot; -X POST -H &quot;Content-Type: application/json&quot; &quot;$&#123;url&#125;/api/v2.0/projects&quot; -d &quot;&#123; \&quot;project_name\&quot;: \&quot;$&#123;project&#125;\&quot;, \&quot;public\&quot;: true&#125;&quot; -k<br>done<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行create_project_harbor.sh创建项目</span><br>root@registry:/opt/harbor# bash create_project_harbor.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">提示“The project named library already exists”可以忽略，因为使用kk部署的Harbor中会创建一个默认的项目library</span><br></code></pre></td></tr></table></figure>

<h3 id="5-7-3-再次修改集群配置文件"><a href="#5-7-3-再次修改集群配置文件" class="headerlink" title="5.7.3 再次修改集群配置文件"></a>5.7.3 再次修改集群配置文件</h3><p>正如官方离线部署文档中所述，使用kk部署harbor前需要前将<code>auths</code>部分注释掉，部署后启用并配置好正确的值。其余内容不变。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">修改k8sV12317-kspV341-offlineconfig.yaml 文件</span><br>root@k8s01-1:/opt/offline-deployk8sksp# vi k8sV12317-kspV341-offlineconfig.yaml<br>...<br>  registry:<br>    # 如需使用 kk 部署 harbor, 可将该参数设置为 harbor，不设置该参数且需使用 kk 创建容器镜像仓库，将默认使用docker registry。<br>    type: harbor<br>    # 如使用 kk 部署的 harbor 或其他需要登录的仓库，可设置对应仓库的auths，如使用 kk 创建的 docker registry 仓库，则无需配置该参数。<br>    # 注意：如使用 kk 部署 harbor，该参数请于 harbor 启动后设置。<br>    auths:<br>      &quot;registry.syjiang.com&quot;:<br>        username: admin<br>        password: Harbor12345<br>        certsPath: &quot;/etc/docker/certs.d/registry.syjiang.com&quot;<br>        skipTLSVerify: false # 即使 TLS校验失败了，仍允许通过HTTPS协议连接registry<br>        plainHTTP: false # 允许通过HTTP协议连接registry<br>    # 设置集群部署时使用的私有仓库<br>    privateRegistry: &quot;registry.syjiang.com&quot;<br>    namespaceOverride: &quot;kubesphereio&quot;<br>    registryMirrors: []<br>    insecureRegistries: []<br>...<br></code></pre></td></tr></table></figure>

<p>相关参数的解释如下：</p>
<ul>
<li>新增 <strong>auths</strong> 配置增加 <strong>registry.syjiang.com</strong> 和账号密码。</li>
<li><strong>certsPath</strong> 配置docker连接 harbor 时私有证书的存放目录。</li>
<li>**skipTLSVerify **配置成false，即使 TLS 校验失败了，仍允许通过HTTPS协议连接registry。</li>
<li>**plainHTTP **配置成false，允许通过HTTP协议连接registry。</li>
<li><strong>privateRegistry</strong> 确认是配置成 <strong>registry.syjiang.com</strong>。</li>
<li><strong>namespaceOverride</strong> 确认是配置成 <strong><code>kubesphereio</code></strong>，它的作用就是K8S本身使用到的镜像只到**<code>registry.syjiang.com/kubesphereio</code><strong>下面去拉取，如果不配置的话有些镜像是会到另外的项目下拉取的比如<code>kube-system</code>空间中<code>pod/snapshot-controller-0</code>用到的镜像就是</strong><code>registry.syjiang.com/csiplugin/snapshot-controller:v4.0.0</code>**。</li>
</ul>
<h3 id="5-7-4-提前推送镜像到-Harbor-仓库"><a href="#5-7-4-提前推送镜像到-Harbor-仓库" class="headerlink" title="5.7.4 提前推送镜像到 Harbor 仓库"></a>5.7.4 提前推送镜像到 Harbor 仓库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">执行如下命令推送镜像到 Harbor 仓库（全部会推送到kubesphereio 项目下）</span><br>root@k8s01-1:/opt/offline-deployk8sksp# ./kk artifact image push -f k8sV12317-kspV341-offlineconfig.yaml -a k8sV12317-kspV341-artifact.tar.gz<br></code></pre></td></tr></table></figure>

<h3 id="5-7-5-查看Harbor镜像仓库"><a href="#5-7-5-查看Harbor镜像仓库" class="headerlink" title="5.7.5 查看Harbor镜像仓库"></a>5.7.5 查看Harbor镜像仓库</h3><p>访问harbor镜像仓库的web管理界面，<code>url</code>是<a href="https://10.13.15.71，默认的用户名与密码分别是：admin、">https://10.13.15.71，默认的用户名与密码分别是：admin、</a> Harbor12345</p>
<p>可以看到如下26个项目，所有镜像都在 kubesphereio 项目下，一共有121个不同名称镜像（标签不同另算） </p>
<p><img src="https://s2.loli.net/2025/01/12/FYCbxXzr1iyqW2P.png" srcset="/img/loading.gif" lazyload alt="image-20250112203033095"></p>
<h1 id="六、安装-KubeSphere-和-K8s-集群"><a href="#六、安装-KubeSphere-和-K8s-集群" class="headerlink" title="六、安装 KubeSphere 和 K8s 集群"></a>六、安装 KubeSphere 和 K8s 集群</h1><h2 id="6-1-安装-K8S-与-KSP"><a href="#6-1-安装-K8S-与-KSP" class="headerlink" title="6.1 安装 K8S 与 KSP"></a>6.1 安装 K8S 与 KSP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">如果重复部署，/data/openebs/local 目录非空，请将此目录下的所有文件清空，否则安装可能失败、提示如下</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">TASK [common : debug] **********************************************************</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">ok: [localhost] =&gt; &#123;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   <span class="hljs-string">&quot;msg&quot;</span>: [</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;1. check the storage configuration and storage server&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;2. make sure the DNS address in /etc/resolv.conf is available&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;3. execute &#x27;kubectl logs -n kubesphere-system -l job-name=minio-make-bucket-job&#x27; to watch logs&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;4. execute &#x27;helm -n kubesphere-system uninstall ks-minio &amp;&amp; kubectl -n kubesphere-system delete job minio-make-bucket-job&#x27;&quot;</span>,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">       <span class="hljs-string">&quot;5. Restart the installer pod in kubesphere-system namespace&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   ]</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">&#125;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">执行以下命令，安装 KubeSphere 和 K8s 集群</span><br>root@k8s01-1:/opt/offline-deployk8sksp# ./kk create cluster -f k8sV12317-kspV341-offlineconfig.yaml -a k8sV12317-kspV341-artifact.tar.gz --with-packages --skip-push-images<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">另外打开一个终端，执行如下命令查看集群部署状态：</span><br>root@k8s01-1:~# kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l &#x27;app in (ks-install, ks-installer)&#x27; -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f<br></code></pre></td></tr></table></figure>

<p><strong>参数说明：</strong></p>
<ul>
<li><strong>k8sV12317-kspV341-offlineconfig.yaml</strong>：离线环境集群的配置文件</li>
<li><strong>k8sV12317-kspV341-artifact.tar.gz</strong>：源集群打包出来的 tar 包镜像</li>
<li><strong>–with-packages</strong>：表示安装安装操作系统依赖组件</li>
<li><strong>–skip-push-images：</strong> 表示跳过推送镜像的操作（因为前文已经操作过了）</li>
</ul>
<p>安装成功完成后，会输出如下信息：</p>
<p><img src="https://s2.loli.net/2025/01/13/TWuogpE9vHMLIhD.png" srcset="/img/loading.gif" lazyload alt="image-20250113095155884"></p>
<h2 id="6-2-配置时间同步服务"><a href="#6-2-配置时间同步服务" class="headerlink" title="6.2 配置时间同步服务"></a>6.2 配置时间同步服务</h2><p>集群所有节点都要操作。在正式部署k8s+ksp集群过程中，会在集群所有节点上安装chrony服务并启动与开机自启动，但使用的默认时间同步服务器需要联网才能访问，离线环境肯定访问不了这些时间同步服务器。故需要使用自己本地的时间同步服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">1.查看节点chrony服务状态</span><br>root@k8s01-1:~# systemctl status chrony<br></code></pre></td></tr></table></figure>

<p>此时必须要有自己的本地部署的 NTP时间同步服务器，自己想办法搭建（可以是k8s集群中任意节点，也可以是其他服务器）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">2.修改配置文件 /etc/chrony/chrony.conf，修改 ntp 服务配置</span><br>vi /etc/chrony/chrony.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">将如下认的 pool 配置删除（离线环境中也用不上）</span><br>pool ntp.ubuntu.com        iburst maxsources 4<br>pool 0.ubuntu.pool.ntp.org iburst maxsources 1<br>pool 1.ubuntu.pool.ntp.org iburst maxsources 1<br>pool 2.ubuntu.pool.ntp.org iburst maxsources 2<br><span class="hljs-meta prompt_"># </span><span class="language-bash">然后配置自己本地的NTP服务器（最好是一台可以访问外网的服务器，这样它可以跟世界范围内的NTP服务器同步时间），NTP服务器步骤此文未涉及</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">假如10.13.15.20是本地NTP服务器，则添加如下配置（如果没有自己本地的时间同步服务器，最后所有节点是没有做严格时间同步的）</span><br>server 10.13.15.20 iburst<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">3.重启 chrony 服务：</span><br>systemctl restart chrony<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">4.验证 chrony 同步状态：</span><br>chronyc sourcestats -v<br></code></pre></td></tr></table></figure>

<h2 id="6-3-问题"><a href="#6-3-问题" class="headerlink" title="6.3   问题"></a>6.3   问题</h2><h3 id="6-3-1-Task-‘monitoring’-执行失败"><a href="#6-3-1-Task-‘monitoring’-执行失败" class="headerlink" title="6.3.1 Task ‘monitoring’ 执行失败"></a>6.3.1 Task ‘monitoring’ 执行失败</h3><p>部署过程中此任务执行失败，但不影响部署主线过程成功完成，所以仍提示部署成功完成。只需要在部署完成后再处理下此任务相关资源对象即可</p>
<p><img src="https://s2.loli.net/2025/01/13/N5K6mEL3iOxDCJT.png" srcset="/img/loading.gif" lazyload alt="image-20250113095337670"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">具体报错文字形式描述如下</span>  <br>  &quot;stdout&quot;: &quot;fatal: [localhost]: FAILED! =&gt; &#123;\&quot;attempts\&quot;: 3, \&quot;changed\&quot;: true, \&quot;cmd\&quot;: \&quot;/usr/local/bin/helm upgrade --install notification-manager /kubesphere/kubesphere/notification-manager -f /kubesphere/kubesphere/notification-manager/custom-values-notification.yaml -n kubesphere-monitoring-system --force\\n\&quot;, \&quot;delta\&quot;: \&quot;0:05:06.023787\&quot;, \&quot;end\&quot;: \&quot;2025-01-12 23:08:54.785785\&quot;, \&quot;msg\&quot;: \&quot;non-zero return code\&quot;, \&quot;rc\&quot;: 1, \&quot;start\&quot;: \&quot;2025-01-12 23:03:48.761998\&quot;, \&quot;stderr\&quot;: \&quot;Error: UPGRADE FAILED: post-upgrade hooks failed: timed out waiting for the condition\&quot;, \&quot;stderr_lines\&quot;: [\&quot;Error: UPGRADE FAILED: post-upgrade hooks failed: timed out waiting for the condition\&quot;], \&quot;stdout\&quot;: \&quot;\&quot;, \&quot;stdout_lines\&quot;: []&#125;&quot;,<br>  &quot;uuid&quot;: &quot;4af3661f-0690-49dd-befe-2b1bdf6d1974&quot;<br></code></pre></td></tr></table></figure>

<p><strong>解决办法：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">当前现状</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system get pods<br>...<br>opensearch-cluster-data-0                                      0/1     Init:ImagePullBackOff   0          11h<br>opensearch-cluster-data-1                                      0/1     Init:ImagePullBackOff   0          11h<br>opensearch-cluster-master-0                                    0/1     Init:ImagePullBackOff   0          11h<br>opensearch-logging-curator-opensearch-curator-28945020-725qp   0/1     Error                   0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-9rprk   0/1     Error                   0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-h2rpk   0/1     Error                   0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-kpm45   0/1     Error                   0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-p2dl9   0/1     Error                   0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-q82qn   0/1     Error                   0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-xkczm   0/1     Error                   0          8h<br><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system describe pod opensearch-cluster-master-0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">发现此pod中尝试拉取与使用镜像 busybox:latest ，竟然是尝试去docker.io 中拉取镜像</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改此pod/opensearch-cluster-master-0中使用的镜像为 registry.syjiang.com/kubesphereio/busybox:1.31.1</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system edit pod opensearch-cluster-master-0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">然后使用同样的方法修改 pod/opensearch-cluster-data-x 中使用的busybox:latest镜像为 registry.syjiang.com/kubesphereio/busybox:1.31.1</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system edit pod opensearch-cluster-data-xxx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">然后可以看到pod/opensearch-cluster-master与pod/opensearch-cluster-data 都变成正常运行状态</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system get pods<br>NAME                                                           READY   STATUS    RESTARTS   AGE<br>...<br>opensearch-cluster-data-0                                      1/1     Running   0          11h<br>opensearch-cluster-data-1                                      1/1     Running   0          11h<br>opensearch-cluster-master-0                                    1/1     Running   0          11h<br>opensearch-logging-curator-opensearch-curator-28945020-725qp   0/1     Error     0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-9rprk   0/1     Error     0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-h2rpk   0/1     Error     0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-kpm45   0/1     Error     0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-p2dl9   0/1     Error     0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-q82qn   0/1     Error     0          8h<br>opensearch-logging-curator-opensearch-curator-28945020-xkczm   0/1     Error     0          9h<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#####################################################################</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#附带问题1：pod/opensearch-logging-curator-opensearch-curator 仍然是 Error 状态</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#####################################################################</span></span><br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2025/01/13/dJ8rIeTRNDsG5ph.png" srcset="/img/loading.gif" lazyload alt="image-20250113100910415"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看其中一个pod/opensearch-logging-curator-opensearch-curator-28945020-725qp</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system describe pod opensearch-logging-curator-opensearch-curator-28945020-725qp<br>...<br>Controlled By:  Job/opensearch-logging-curator-opensearch-curator-28945020<br>...<br><span class="hljs-meta prompt_">#</span><span class="language-bash">过去了8个小时，此时事件已经为None</span><br>...<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">发现上述pod/opensearch-logging-curator-opensearch-curator-28945020-725qp由Job/opensearch-logging-curator-opensearch-curator-28945020 控制</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">于是查看 Job/opensearch-logging-curator-opensearch-curator-28945020</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system describe job opensearch-logging-curator-opensearch-curator-28945020<br>Name:             opensearch-logging-curator-opensearch-curator-28945020<br>Namespace:        kubesphere-logging-system<br>Selector:         controller-uid=d759cadd-c7d9-46aa-9e1a-a2dada8a8597<br>Labels:           app=opensearch-curator<br>                  release=opensearch-logging-curator<br>Annotations:      revisions:<br>                    &#123;&quot;1&quot;:&#123;&quot;status&quot;:&quot;failed&quot;,&quot;reasons&quot;:[&quot;BackoffLimitExceeded&quot;],&quot;messages&quot;:[&quot;Job has reached the specified backoff limit&quot;],&quot;desire&quot;:1,&quot;failed&quot;:...<br>Controlled By:    CronJob/opensearch-logging-curator-opensearch-curator<br>...<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看CronJob/opensearch-logging-curator-opensearch-curator</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system describe cronjobs.batch opensearch-logging-curator-opensearch-curator <br>Name:                          opensearch-logging-curator-opensearch-curator<br>Namespace:                     kubesphere-logging-system<br>Labels:                        app=opensearch-curator<br>                               app.kubernetes.io/managed-by=Helm<br>                               chart=opensearch-curator-0.0.5<br>                               heritage=Helm<br>                               release=opensearch-logging-curator<br>Annotations:                   meta.helm.sh/release-name: opensearch-logging-curator<br>                               meta.helm.sh/release-namespace: kubesphere-logging-system<br>Schedule:                      0 1 * * *<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">由上可知，上述失败7个pod由Job/opensearch-logging-curator-opensearch-curator-28945020 控制，而Job/opensearch-logging-curator-opensearch-curator-28945020 由 CronJob/opensearch-logging-curator-opensearch-curator 控制。它每1个小时执行一次</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">所以暂时可以不用理会上述报错的7个pod，如果想迅速看到成功的记录，可以去 kubesphere的web管理界面重新执行上述job</span><br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2025/01/13/tbTjiM39XGsBowg.png" srcset="/img/loading.gif" lazyload alt="image-20250113104345346"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以看到新创建的 pod/opensearch-logging-curator-opensearch-curator-28945020-7r6ql 是Completed状态，表示正常完成</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system get pods<br>NAME                                                           READY   STATUS      RESTARTS   AGE<br>...<br>opensearch-logging-curator-opensearch-curator-28945020-725qp   0/1     Error       0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-7r6ql   0/1     Completed   0          24s<br>opensearch-logging-curator-opensearch-curator-28945020-9rprk   0/1     Error       0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-h2rpk   0/1     Error       0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-kpm45   0/1     Error       0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-p2dl9   0/1     Error       0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-q82qn   0/1     Error       0          9h<br>opensearch-logging-curator-opensearch-curator-28945020-xkczm   0/1     Error       0          9h<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看其日志</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system logs opensearch-logging-curator-opensearch-curator-28945020-7r6ql<br><span class="hljs-meta prompt_">#</span><span class="language-bash">其他7个处于Error 状态的pod/opensearch-logging-curator-opensearch-curator-28945020-xxx 是由job不断创建新pod直到达到尝试上限7而生成（spec.backoffLimit默认为6，即重试6次，共7个pod）pod都失败后，认为job失败</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">此时可以删除上述处于Error 状态的pod/opensearch-logging-curator-opensearch-curator-28945020-xxx，也可以不理会</span><br>root@k8s01-1:~# kubectl -n kubesphere-logging-system get pod | grep opensearch-logging-curator-opensearch-curator-28945020 | grep -v &quot;opensearch-logging-curator-opensearch-curator-28945020-7r6ql&quot; | awk &#x27;&#123;print $1&#125;&#x27; | xargs kubectl -n kubesphere-logging-system delete pod<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#####################################################################</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#附带问题2：istio-system空间中pod/jaeger-es-index-cleaner-xxx 仍然是 Error 状态</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#####################################################################</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash">root@k8s01-1:~# kubectl -n istio-system get pods</span><br>NAME                                     READY   STATUS    RESTARTS        AGE<br>istiod-1-14-6-775dfd88cd-jhc69           1/1     Running   0               12h<br>jaeger-collector-b4555bcd4-s9b9w         1/1     Running   139 (60m ago)   12h<br>jaeger-es-index-cleaner-28944955-52ggg   0/1     Error     0               11h<br>jaeger-es-index-cleaner-28944955-5fdln   0/1     Error     0               11h<br>jaeger-es-index-cleaner-28944955-6crz4   0/1     Error     0               10h<br>jaeger-es-index-cleaner-28944955-7hkwt   0/1     Error     0               11h<br>jaeger-es-index-cleaner-28944955-brdhh   0/1     Error     0               10h<br>jaeger-es-index-cleaner-28944955-dmrtx   0/1     Error     0               10h<br>jaeger-es-index-cleaner-28944955-mzx44   0/1     Error     0               11h<br>...<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">通过查看pod/jaeger-es-index-cleaner-28944955-52ggg 日志，发现其也是因为不能正常使用 ns/kubesphere-logging-system 下opensearch-cluster-data 相关svc与pod提供的服务而造成相关job执行失败</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">所以同样也可以去kubesphere的web界面重新执行 job/jaeger-es-index-cleaner-28944955 即可</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">然后将创建一个新的pod/jaeger-es-index-cleaner-28944955-tznkj 并是处于Completed 状态</span><br>root@k8s01-1:~# kubectl -n istio-system get pods<br>NAME                                     READY   STATUS      RESTARTS        AGE<br>istiod-1-14-6-775dfd88cd-jhc69           1/1     Running     0               12h<br>jaeger-collector-b4555bcd4-s9b9w         1/1     Running     139 (62m ago)   12h<br>jaeger-es-index-cleaner-28944955-52ggg   0/1     Error       0               11h<br>jaeger-es-index-cleaner-28944955-5fdln   0/1     Error       0               11h<br>jaeger-es-index-cleaner-28944955-6crz4   0/1     Error       0               11h<br>jaeger-es-index-cleaner-28944955-7hkwt   0/1     Error       0               11h<br>jaeger-es-index-cleaner-28944955-brdhh   0/1     Error       0               10h<br>jaeger-es-index-cleaner-28944955-dmrtx   0/1     Error       0               10h<br>jaeger-es-index-cleaner-28944955-mzx44   0/1     Error       0               11h<br>jaeger-es-index-cleaner-28944955-tznkj   0/1     Completed   0               9s<br>jaeger-operator-846bc67879-hwc7r         1/1     Running     0               12h<br>jaeger-query-579b5c5f7c-hhwk8            2/2     Running     137 (59m ago)   12h<br>kiali-6cd665f559-2g8mx                   1/1     Running     0               12h<br>kiali-operator-745866d585-xvfwh          1/1     Running     0               12h<br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除先前遗留下来的垃圾pod(可选)</span><br>root@k8s01-1:~# kubectl -n istio-system get pods  | grep Error | awk &#x27;&#123;print $1&#125;&#x27; | xargs kubectl -n istio-system delete pod<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">到目前为止 ，集群中所有pod都是正常运行状态或正常结束状态</span><br></code></pre></td></tr></table></figure>

<h2 id="6-4-部署结果验证"><a href="#6-4-部署结果验证" class="headerlink" title="6.4  部署结果验证"></a>6.4  部署结果验证</h2><h3 id="6-4-1-命令行查看"><a href="#6-4-1-命令行查看" class="headerlink" title="6.4.1 命令行查看"></a>6.4.1 命令行查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看k8s集群节点列表</span><br>root@k8s01-1:~# kubectl get node<br>NAME      STATUS   ROLES                         AGE   VERSION<br>k8s01-1   Ready    control-plane,master,worker   12h   v1.23.17<br>k8s01-2   Ready    control-plane,master,worker   12h   v1.23.17<br>k8s01-3   Ready    control-plane,master,worker   12h   v1.23.17<br>k8s01-4   Ready    worker                        12h   v1.23.17<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看k8s集群组件状态</span><br>root@k8s01-1:~# kubectl get cs<br>Warning: v1 ComponentStatus is deprecated in v1.19+<br>NAME                 STATUS    MESSAGE             ERROR<br>controller-manager   Healthy   ok                  <br>scheduler            Healthy   ok                  <br>etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   <br>etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   <br>etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125; <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看calico 节点</span><br>root@k8s01-1:~# calicoctl node status<br>Calico process is running.<br><br>IPv4 BGP status<br>+--------------+-------------------+-------+----------+-------------+<br>| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |<br>+--------------+-------------------+-------+----------+-------------+<br>| 10.13.15.17  | node-to-node mesh | up    | 14:43:14 | Established |<br>| 10.13.15.161 | node-to-node mesh | up    | 14:43:15 | Established |<br>| 10.13.15.99  | node-to-node mesh | up    | 14:43:13 | Established |<br>+--------------+-------------------+-------+----------+-------------+<br>...<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看所有pod(集群中所有pod都是正常运行状态或正常结束状态)</span><br>root@k8s01-1:~# kubectl get pods -A -o wide<br></code></pre></td></tr></table></figure>

<h3 id="6-4-2-查看ksp3-4-1的web管理界面"><a href="#6-4-2-查看ksp3-4-1的web管理界面" class="headerlink" title="6.4.2 查看ksp3.4.1的web管理界面"></a>6.4.2 查看ksp3.4.1的web管理界面</h3><p>访问kubesphere3.4.1的web管理界面：<a target="_blank" rel="noopener" href="http://10.13.15.16:30880/login">http://10.13.15.16:30880/login</a> ，默认用户名：admin，其默认密码：P@88w0rd</p>
<p><img src="https://s2.loli.net/2025/01/13/uAV8QrZEKHyX35t.png" srcset="/img/loading.gif" lazyload alt="image-20250113145359197"></p>
<h2 id="6-5-控制节点配置keepalived"><a href="#6-5-控制节点配置keepalived" class="headerlink" title="6.5 控制节点配置keepalived"></a>6.5 控制节点配置keepalived</h2><p>参考 <a href="https://jiangsanyin.github.io/2024/08/10/%E6%90%AD%E5%BB%BA%E4%BA%92%E4%B8%BA%E4%B8%BB%E5%A4%87MySQL5-7%E9%9B%86%E7%BE%A4%E5%B9%B6%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2/#2-3-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AEkeepalived">https://jiangsanyin.github.io/2024/08/10/%E6%90%AD%E5%BB%BA%E4%BA%92%E4%B8%BA%E4%B8%BB%E5%A4%87MySQL5-7%E9%9B%86%E7%BE%A4%E5%B9%B6%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2/#2-3-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AEkeepalived</a></p>
<h1 id="七、参考文章"><a href="#七、参考文章" class="headerlink" title="七、参考文章"></a>七、参考文章</h1><ul>
<li><p>kubesphere官网离线部署文档：<a target="_blank" rel="noopener" href="https://www.kubesphere.io/zh/docs/v3.4/installing-on-linux/introduction/air-gapped-installation">https://www.kubesphere.io/zh/docs/v3.4/installing-on-linux/introduction/air-gapped-installation</a></p>
</li>
<li><p>kubesphere关于部署配置文件的描述：<a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/blob/master/docs/config-example.md">https://github.com/kubesphere/kubekey/blob/master/docs/config-example.md</a></p>
</li>
<li><p>kubesphere在cnblogs上的博文：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kubesphere/p/18208852">https://www.cnblogs.com/kubesphere/p/18208852</a></p>
</li>
<li><p>运维博主运维有术文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/672059287">https://zhuanlan.zhihu.com/p/672059287</a></p>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/k8s%E4%BA%91%E5%8E%9F%E7%94%9F/" class="category-chain-item">k8s云原生</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/amd64%E6%9E%84%E6%9E%B6-k8s1-23-17-kubesphere3-4-1-%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2/" class="print-no-link">#amd64构架 k8s1.23.17 kubesphere3.4.1 离线部署</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>k8s离线部署-使用kubekey部署amd64高可用版k8s1.23.17-ksp3.4.1</div>
      <div>https://jiangsanyin.github.io/2024/09/27/k8s离线部署-使用kubekey部署amd64高可用版k8s1-23-17-ksp3-4-1/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>sanyinjiang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年9月27日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/10/07/GPU%E8%99%9A%E6%8B%9F%E5%8C%96%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEHAMi%E4%B8%AD%E4%BD%BF%E7%94%A8prometheus%E4%B8%8Egrafana%E5%81%9A%E7%9B%91%E6%8E%A7/" title="GPU虚拟化开源项目HAMi中使用prometheus与grafana做监控">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">GPU虚拟化开源项目HAMi中使用prometheus与grafana做监控</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/09/07/M3%E8%8A%AF%E7%89%87MacOS14-6-1%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E7%A0%B4%E8%A7%A3%E7%89%88SecureCRT%E4%B8%8ESecureFX/" title="M3芯片MacOS14.6.1系统安装配置破解版SecureCRT与SecureFX">
                        <span class="hidden-mobile">M3芯片MacOS14.6.1系统安装配置破解版SecureCRT与SecureFX</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"lhgjNNoNy5Syl0F4Bw8i5P5K-gzGzoHsz","appKey":"0d6M8Wx7ZmYewOQqA20Nbqen","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
